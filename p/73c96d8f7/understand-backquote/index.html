<!doctype html><html lang=zh-cn><head><meta name=color-scheme content="dark"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.139.4"><meta name=description content="这里是 Celestial.y 的网络空间站。"><meta property="og:title" content="关于 backquote 理解的一个汇总与总结"><meta property="og:description" content="这里是 Celestial.y 的网络空间站。"><meta property="og:image:url" content="https://blog.celestialy.top/p/73c96d8f7/understand-backquote/pic.external/include-yy/article_hu4915359183328694036.webp"><meta property="og:image:width" content="1200"><meta property="og:image.height" content="675"><meta property="og:image:type" content="image/webp"><meta property="og:url" content="https://blog.celestialy.top/p/73c96d8f7/understand-backquote/"><meta property="og:site_name" content="clsty 的网络空间站"><meta property="og:type" content="article"><meta property="article:section" content="blog"><meta property="article:published_time" content="2022-03-14T22:57:00+08:00"><meta property="article:modified_time" content="2024-04-21T23:15:00+08:00"><meta property="article:tag" content="lisp"><meta property="article:tag" content="emacs"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://blog.celestialy.top/p/73c96d8f7/understand-backquote/pic.external/include-yy/article_hu4915359183328694036.webp"><meta name=twitter:title content="关于 backquote 理解的一个汇总与总结"><meta name=twitter:description content="这里是 Celestial.y 的网络空间站。"><script type=application/ld+json>{"@context":"https://schema.org","@type":"NewsArticle","dateModified":"2024-04-21T23:15:00+08:00","datePublished":"2022-03-14T22:57:00+08:00","headline":"关于 backquote 理解的一个汇总与总结","image":["https://blog.celestialy.top/p/73c96d8f7/understand-backquote/pic.external/include-yy/article_hu4915359183328694036.webp"]}</script><title>关于 backquote 理解的一个汇总与总结 | clsty 的网络空间站
</title><link rel=preload href=/IBM-Plex-Sans/fonts/split/woff2/IBMPlexSans-Bold-Latin1.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/IBM-Plex-Sans/fonts/split/woff2/IBMPlexSans-Regular-Latin1.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/IBM-Plex-Sans-Condensed/fonts/split/woff2/IBMPlexSansCondensed-Light-Latin1.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/IBM-Plex-Sans-Condensed/fonts/split/woff2/IBMPlexSansCondensed-Text-Latin1.woff2 as=font type=font/woff2 crossorigin><link rel=preload href=/IBM-Plex-Sans-Condensed/fonts/split/woff2/IBMPlexSansCondensed-SemiBold-Latin1.woff2 as=font type=font/woff2 crossorigin><link rel=stylesheet href=/css/fontfaces.min.5442583bc9892da790ae4dfc5e0be3a914b9a11806fc02b0c0ed61f0456e76a1.css integrity="sha256-VEJYO8mJLaeQrk38XgvjqRS5oRgG/AKwwO1h8EVudqE=" media=screen><link rel=stylesheet href=/css/screen.min.b2bfc25fa5b5fb7d7ff2571c70968e348a33f0811b9739e6c79eaba594c86eb2.css integrity="sha256-sr/CX6W1+31/8lcccJaONIoz8IEblznmx56rpZTIbrI=" media=screen><link rel=stylesheet href=/css/custom.min.aee6477538ab4ab378a04100067edf126d56e3a31c3c58987fd57d65953d1cc9.css integrity="sha256-ruZHdTirSrN4oEEABn7fEm1W46McPFiYf9V9ZZU9HMk=" media=screen><script src=/js/ls.min.6caaaee2899d2d0bb2cd66e696389981f80744632f18ac48f14a6b0f559c46bd.js integrity="sha256-bKqu4omdLQuyzWbmljiZgfgHRGMvGKxI8UprD1WcRr0=" async></script><link rel=icon type=image/svg+xml href=/favicon/favicon.svg><link rel=icon type=image/png href=/favicon/favicon.png><link rel=stylesheet href=/css/pagestyle/post.css integrity media=screen></head><body><script>let FF_FOUC_FIX</script><header class="l-masthead l-nav" id=l-masthead><div class="ctrl ctrl-left" id=l-logo><a class="ctrl__title ctrl__title--text nav__title" href=https://blog.celestialy.top/><span>clsty 的网络空间站</span></a></div><div class="ctrl ctrl-left" id=l-menu><nav><ul class=ul--row><li><a class="ctrl__menulink nav-main__link" href=/>❀新鲜事❀</a></li><li><a class="ctrl__menulink nav-main__link has-active" href=/blog/>❈散文屋❈</a></li><li><a class="ctrl__menulink nav-main__link" href=/doc/>❉文档馆❉</a></li><li><a class="ctrl__menulink nav-main__link" href=/authors/>・人・</a></li><li><a class="ctrl__menulink nav-main__link" href=/categories/>〈  类别</a></li><li><a class="ctrl__menulink nav-main__link" href=/series/>|  系列  |</a></li><li><a class="ctrl__menulink nav-main__link" href=/tags/>标签  〉</a></li></ul></nav></div><div class="ctrl ctrl-right" id=l-ctrl><nav><ul class=ul--row></ul></nav><a href=/search/ id=search class=ctrl__button title="Open search"><span class='icon icon--material icon--normal'><svg viewBox="0 0 24 24"><path d="m19.55 20.575-6.3-6.275q-.75.625-1.725.975t-2 .35q-2.575.0-4.35-1.775Q3.4 12.075 3.4 9.5q0-2.55 1.775-4.338 1.775-1.787 4.35-1.787 2.55.0 4.325 1.775 1.775 1.775 1.775 4.35.0 1.075-.35 2.05-.35.975-.95 1.7l6.275 6.275zm-10.025-6.45q1.925.0 3.263-1.35 1.337-1.35 1.337-3.275.0-1.925-1.337-3.275-1.338-1.35-3.263-1.35-1.95.0-3.287 1.35Q4.9 7.575 4.9 9.5t1.338 3.275q1.337 1.35 3.287 1.35z"/></svg></span>
</a><button id=toggle-toc class=ctrl__button aria-label="Toggle TOC" title=开/关导航目录><span class="icon icon--material"></span></button><aside class=is-closed id=toc><div class=toc__box><div class=toc__content><nav class=toc__list><h2 class=toc__title><a href=#l-content-box class=nav__link>在此页面上</a></h2><ul><li class="nav__item nav__item--2"><a href=/p/73c96d8f7/understand-backquote/#%e4%bb%80%e4%b9%88%e6%98%af-backquote>什么是 backquote</a></li><li class="nav__item nav__item--2"><a href=/p/73c96d8f7/understand-backquote/#cl-%e6%a0%87%e5%87%86%e4%b8%ad%e5%af%b9%e4%ba%8e-backquote-%e7%9a%84%e6%8f%8f%e8%bf%b0>CL 标准中对于 backquote 的描述</a></li><li class="nav__item nav__item--2"><a href=/p/73c96d8f7/understand-backquote/#%e6%80%8e%e4%b9%88%e7%90%86%e8%a7%a3%e5%b5%8c%e5%a5%97%e7%9a%84>怎么理解嵌套的</a></li><li class="nav__item nav__item--2"><a href=/p/73c96d8f7/understand-backquote/#%e5%87%a0%e7%a7%8d%e5%b8%b8%e8%a7%81%e7%9a%84%e5%b5%8c%e5%a5%97-backquote-%e7%bb%84%e5%90%88>几种常见的嵌套 backquote 组合</a><ul><li class="nav__item nav__item--3"><a href=/p/73c96d8f7/understand-backquote/#->① <code>,,</code></a></li><li class="nav__item nav__item--3"><a href=/p/73c96d8f7/understand-backquote/#--1>② <code>,',</code></a></li><li class="nav__item nav__item--3"><a href=/p/73c96d8f7/understand-backquote/#--%e5%92%8c->③ <code>,@,</code> 和 <code>,@',</code></a></li><li class="nav__item nav__item--3"><a href=/p/73c96d8f7/understand-backquote/#--%e5%92%8c--1>④ <code>,,@</code> 和 <code>,',@</code></a></li><li class="nav__item nav__item--3"><a href=/p/73c96d8f7/understand-backquote/#--%e5%92%8c--2>⑤ <code>,@,@</code> 和 <code>,@',@</code></a></li><li class="nav__item nav__item--3"><a href=/p/73c96d8f7/understand-backquote/#cl-%e4%b8%ad-backquote-%e7%9a%84%e4%b8%80%e4%b8%aa%e6%9e%81%e7%ae%80%e5%ae%9e%e7%8e%b0>CL 中 backquote 的一个极简实现</a></li></ul></li><li class="nav__item nav__item--2"><a href=/p/73c96d8f7/understand-backquote/#elisp-%e4%b8%ad%e7%9a%84-backquote-%e5%ae%9e%e7%8e%b0>elisp 中的 backquote 实现</a></li><li class="nav__item nav__item--2"><a href=/p/73c96d8f7/understand-backquote/#%e5%b0%be%e5%a3%b0>尾声</a></li></ul></nav></div></div></aside></div></header><div class=l-page><main id=l-main class=l-tnp><div id=l-content-box class="l-box l-box--full"><article id=l-content data-pagefind-body><header class=page-header><div class="meta meta--head meta--left" data-pagefind-ignore><ul class=meta__list><li class="taxo-shape taxo-shape--category"><ul class=ul--row><li class=meta__hanging><a class="link link--nav" href=/categories/ title="All Categories"><span class='icon icon--material icon--tiny'><svg viewBox="0 0 20 20"><path d="m5.042 9.479 4.979-8.146L15 9.479zm9.666 9.167q-1.646.0-2.791-1.156-1.146-1.157-1.146-2.782.0-1.646 1.146-2.791 1.145-1.146 2.791-1.146 1.625.0 2.782 1.146 1.156 1.145 1.156 2.791.0 1.625-1.156 2.782-1.157 1.156-2.782 1.156zm-12.583-.417v-7.062h7.063v7.062z"/></svg></span></a></li><li class="meta__item meta__item--taxo"><a class="meta__text link link--nav" href=/categories/knowledge/>知识向</a></li></ul></li><li class="taxo-shape taxo-shape--tag"><ul class=ul--row><li class=meta__hanging><a class="link link--nav" href=/tags/ title="All Tags"><span class='icon icon--material icon--tiny'><svg viewBox="0 0 20 20"><path d="M3.188 10.542v5.875L.917 15.5zm4.062 7.75h-2.5V11.5zm1.958.75L4.146 5.333 14 1.75l5.042 13.729zm.021-10.5q.396.0.677-.282.282-.281.282-.677.0-.375-.282-.656-.281-.281-.677-.281-.375.0-.656.281t-.281.656q0 .396.281.677.281.282.656.282z"/></svg></span></a></li><li class="meta__item meta__item--taxo"><a class="meta__text link link--nav" href=/tags/lisp/>Lisp
</a>&zwj;<span class=meta__separator>•</span></li><li class="meta__item meta__item--taxo"><a class="meta__text link link--nav" href=/tags/emacs/>Emacs</a></li></ul></li></ul><div class=published><ul class=author-list><li><a href=/authors/include-yy/ title=include-yy><figure class="fig fig--w-pt2 fig--portrait-small"><span class="img__frame img__frame--bg-white"><span class="img__c img__c--t-symbol"><img alt=include-yy class=img--svg loading=lazy src=/authors/include-yy/avatar.svg></span></span></figure></a></li></ul><ul class="meta__list meta__list--date"><li class=meta__item><span class=meta__icon><span class='icon icon--material icon--tiny'><svg viewBox="0 0 20 20"><path d="M12.021 14.938q-.896.0-1.521-.615t-.625-1.49q0-.895.625-1.521.625-.624 1.521-.624.875.0 1.489.624.615.626.615 1.521.0.875-.615 1.49-.614.615-1.489.615zM2.333 18.5V3.25h2.584V1.5h1.875v1.75h6.416V1.5h1.875v1.75h2.584V18.5zm1.979-1.979h11.376V8.375H4.312z"/></svg></span>
</span><time class=meta__text datetime=2022-03-14T22:57:00+08:00>Mar 14, 2022</time></li><li class="meta__item meta__date"><span class='icon icon--material icon--tiny'><svg viewBox="0 0 20 20"><path d="M10 18.5q-1.771.0-3.323-.667-1.552-.666-2.698-1.812t-1.812-2.698Q1.5 11.771 1.5 10t.667-3.323q.666-1.552 1.812-2.698t2.698-1.812Q8.229 1.5 10 1.5t3.323.667q1.552.666 2.698 1.812t1.812 2.698Q18.5 8.229 18.5 10t-.667 3.323q-.666 1.552-1.812 2.698t-2.698 1.812Q11.771 18.5 10 18.5zm2.583-4.562 1.375-1.355-3-2.979V5.896H9.042v4.458z"/></svg></span>
<span class=meta__text>10:57 pm</span></li></ul></div></div><div class="title title--sans margin-full"><h1 data-pagefind-weight=10>关于 backquote 理解的一个汇总与总结</h1></div><aside class=featured-image><figure class="fig fig--ph-right fig--w-small fig--featured"><span class="img__frame img__frame--box-shadow" style="display:flex;justify-content:center;align-items:center;background-image:linear-gradient(to right,#dcd7d4,#504c56)"><span class=img__c style=position:relative;width:100%;height:0;padding-bottom:133.3333%><img alt=featured class="img--ls img--ph lazyload" data-optimumx=auto data-sizes=auto data-srcset="/p/73c96d8f7/understand-backquote/pic.external/include-yy/article-256x.webp 256w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/article-286x.webp 286w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/article-319x.webp 319w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/article-330x.webp 330w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/article-356x.webp 356w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/article-397x.webp 397w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/article-444x.webp 444w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/article-495x.webp 495w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/article-553x.webp 553w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/article-617x.webp 617w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/article-689x.webp 689w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/article-769x.webp 769w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/article-858x.webp 858w" height=440 src=/p/73c96d8f7/understand-backquote/pic.external/include-yy/article-330x.webp srcset=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 width=330></span></span></figure></aside></header><div class="md md--sans md--h-sans md--margin-full"><style>.wordcount-label{font-size:16px;text-align:right}</style><span class=wordcount-label>字词数：6529&nbsp;&nbsp;&nbsp;✧&nbsp;&nbsp;&nbsp;</span><style>.pageviews-label{font-size:16px;text-align:right}</style><span class=pageviews-label>阅读量：<span class=pageviews-label id=ArtalkPV></span>&nbsp;&nbsp;&nbsp;✧&nbsp;&nbsp;</span>
<time id=LastmodTime datetime=2024-4-21></time>
<span id=expiredTip class=expiredTip-label></span><style>.expiredTip-label{font-size:16px}</style><script>function GetNumberOfDays(e,t){var n=Date.parse(new Date(e)),s=Date.parse(new Date(t)),o=parseInt((s-n)/(1e3*60*60*24));return o}var date=new Date,ny=date.getFullYear(),nm=date.getMonth()+1,nd=date.getDate(),a1=document.getElementById("LastmodTime").dateTime,a2=ny+"-"+nm+"-"+nd,num=GetNumberOfDays(a1,a2),str1="最近更新：距今",str2="日";document.getElementById("expiredTip").innerHTML=str1+"&nbsp;"+num+"&nbsp;"+str2</script><div id=permaportalValue style=display:none>73c96d8f7</div><p class=box style=white-space:nowrap;font-size:1.2em;overflow-x:auto;clear:none>以下按钮可供你方便地引用本文。URL 中即使域名变化，其后的路径也将始终指向原本的内容。
<script>function copyToClipboard(e,t){var n,s,o=document.getElementById(e).innerText;navigator.clipboard.writeText(o),n=document.getElementById(t),s=n.textContent,n.textContent="✓ 已复制",setTimeout(function(){n.textContent=s},1200)}</script><br><button id=permaportal-button onclick='copyToClipboard("permaportallink","permaportal-button")' class=permaportal--button>单击复制</button>
<span id=permaportallink class=permaportal--linkbox>https://blog.celestialy.top/p/73c96d8f7</span><br><button id=permaportal-button-md onclick='copyToClipboard("permaportallink-md","permaportal-button-md")' class=permaportal--button>markdown</button>
<span id=permaportallink-md class=permaportal--linkbox>[关于 backquote 理解的一个汇总与总结 | clsty 的网络空间站](https://blog.celestialy.top/p/73c96d8f7)</span><br><button id=permaportal-button-org onclick='copyToClipboard("permaportallink-org","permaportal-button-org")' class=permaportal--button>org-mode</button>
<span id=permaportallink-org class=permaportal--linkbox>[[https://blog.celestialy.top/p/73c96d8f7][关于 backquote 理解的一个汇总与总结 | clsty 的网络空间站]]</span></p><p>我于今年的 2 月 22 日开始在 emacs-china 上写这篇文章<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>，并在 3 月 14 日完成。不幸地是，2022 年 6 月 20 日 emacs-china 因为一些原因暂时闭站了，随后在今天（也就是 26 日）重新恢复。（顺带一提，adnmb 在 20 日重新以 nmbxd 浮起来了）。</p><p>将近一周的时间没有 emacs-china 可逛让我感觉浑身难受，不过这同时也提醒我自己写的东西要保存好，只有在自己硬盘里面的东西才真正是自己的，本文完成后我没有保存源文档，我还有点担心它会随着闭站直接消失掉（笑）。adnmb 中的许多精华帖子在新岛中也找不到了，听说之后会逐步恢复。看来要想留下点自己记得住的东西还得自己动手。好了，闲话少说，以下是正文部分。</p><hr><p>今天读了读 emacs 中 generalized variable 的实现方法，gv.el 的代码中用到一些了宏生成宏的技巧，我想着要不要做个关于嵌套 backquote 的总结。</p><p>本文使用的代码环境如下：</p><ul><li>emacs 27.2 x86_64 on windows</li><li>ecl 21.2</li><li>sbcl 2.0.0</li><li>racket 8.2</li></ul><p>本文中会使用两种 common lisp 实现，它们分别是 embedded common lisp 和 steel bank common lisp。在需要对不同实现做区分时我会在代码块中以注释说明使用的是哪一种。</p><h2 id=什么是-backquote><a class=h-a href=#%e4%bb%80%e4%b9%88%e6%98%af-backquote>什么是 backquote</a></h2><p>首先我们从认识什么是 <code>`</code> 开始。在不同的 Lisp 中它不一定是同一个东西。</p><p>在 elisp 中它是 backquote 宏的别名，它的实现位于 backquote.el 中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elisp data-lang=elisp><span class=line><span class=ln id=hl-0-1><a class=lnlinks href=#hl-0-1>1</a></span><span class=cl><span class=p>(</span><span class=nv>macrop</span> <span class=p>(</span><span class=nf>symbol-function</span> <span class=ss>&#39;\`</span><span class=p>))</span> <span class=nv>=&gt;</span> <span class=no>t</span>
</span></span><span class=line><span class=ln id=hl-0-2><a class=lnlinks href=#hl-0-2>2</a></span><span class=cl><span class=p>(</span><span class=nf>eq</span> <span class=p>(</span><span class=nf>symbol-function</span> <span class=ss>&#39;\`</span><span class=p>)</span> <span class=p>(</span><span class=nf>symbol-function</span> <span class=ss>&#39;backquote</span><span class=p>))</span> <span class=nv>=&gt;</span> <span class=no>t</span>
</span></span></code></pre></div><p>在 Scheme 中它是 <code>quasiquote</code> 的缩写，它是一个 <em>special form</em> ：<a class="link link--text" href=https://docs.racket-lang.org/reference/quasiquote.html rel=external>racket quasiquoting</a> 。</p><p>在 CL 中它是个 <em>macro character</em> （宏字符），与之关联的 <em>reader macro</em> （读取宏）在读到类似 <code>`(a1 a2 ...)</code> 的表达式时 CL 会将其转换为类似 <code>(backquote (a1 a2 ...))</code> 的形式。</p><p>下面是我在 ECL 中得到的结果：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-1-1><a class=lnlinks href=#hl-1-1> 1</a></span><span class=cl><span class=c1>;;ECL</span>
</span></span><span class=line><span class=ln id=hl-1-2><a class=lnlinks href=#hl-1-2> 2</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-1-3><a class=lnlinks href=#hl-1-3> 3</a></span><span class=cl><span class=nv>CL-USER&gt;</span> <span class=p>(</span><span class=nf>read</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-1-4><a class=lnlinks href=#hl-1-4> 4</a></span><span class=cl><span class=o>`</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-1-5><a class=lnlinks href=#hl-1-5> 5</a></span><span class=cl><span class=p>(</span><span class=nv>SI:QUASIQUOTE</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-1-6><a class=lnlinks href=#hl-1-6> 6</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-1-7><a class=lnlinks href=#hl-1-7> 7</a></span><span class=cl><span class=nv>CL-USER&gt;</span> <span class=p>(</span><span class=nf>read</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-1-8><a class=lnlinks href=#hl-1-8> 8</a></span><span class=cl><span class=o>`</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=o>`</span><span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=mi>4</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-1-9><a class=lnlinks href=#hl-1-9> 9</a></span><span class=cl><span class=p>(</span><span class=nv>SI:QUASIQUOTE</span>
</span></span><span class=line><span class=ln id=hl-1-10><a class=lnlinks href=#hl-1-10>10</a></span><span class=cl> <span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=p>(</span><span class=nv>SI:QUASIQUOTE</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=p>(</span><span class=nv>SI:UNQUOTE</span> <span class=p>(</span><span class=nf>+</span> <span class=p>(</span><span class=nv>SI:UNQUOTE</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span> <span class=mi>4</span><span class=p>))))))</span>
</span></span><span class=line><span class=ln id=hl-1-11><a class=lnlinks href=#hl-1-11>11</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-1-12><a class=lnlinks href=#hl-1-12>12</a></span><span class=cl><span class=nv>CL-USER&gt;</span> <span class=p>(</span><span class=nf>read</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-1-13><a class=lnlinks href=#hl-1-13>13</a></span><span class=cl><span class=o>`</span><span class=p>(</span><span class=nf>+</span> <span class=o>,@</span><span class=p>(</span><span class=nc>list</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-1-14><a class=lnlinks href=#hl-1-14>14</a></span><span class=cl><span class=p>(</span><span class=nv>SI:QUASIQUOTE</span> <span class=p>(</span><span class=nf>+</span> <span class=p>(</span><span class=nv>SI:UNQUOTE-SPLICE</span> <span class=p>(</span><span class=nv>LIST</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))))</span>
</span></span><span class=line><span class=ln id=hl-1-15><a class=lnlinks href=#hl-1-15>15</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-1-16><a class=lnlinks href=#hl-1-16>16</a></span><span class=cl><span class=nv>CL-USER&gt;</span> <span class=o>&#39;`</span><span class=p>(</span><span class=nf>+</span> <span class=o>,.</span><span class=p>(</span><span class=nc>list</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-1-17><a class=lnlinks href=#hl-1-17>17</a></span><span class=cl><span class=p>(</span><span class=nv>SI:QUASIQUOTE</span> <span class=p>(</span><span class=nf>+</span> <span class=p>(</span><span class=nv>SI:UNQUOTE-NSPLICE</span> <span class=p>(</span><span class=nv>LIST</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))))</span>
</span></span><span class=line><span class=ln id=hl-1-18><a class=lnlinks href=#hl-1-18>18</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-1-19><a class=lnlinks href=#hl-1-19>19</a></span><span class=cl><span class=nv>CL-USER&gt;</span> <span class=p>(</span><span class=nf>symbol-function</span> <span class=ss>&#39;si:quasiquote</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-1-20><a class=lnlinks href=#hl-1-20>20</a></span><span class=cl><span class=p>(</span><span class=nv>SI:MACRO</span> <span class=o>.</span> <span class=err>#</span><span class=nv>&lt;compiled-function</span> <span class=nv>SI:QUASIQUOTE</span> <span class=nv>0x244bd00&gt;</span><span class=p>)</span>
</span></span></code></pre></div><p>在 SBCL 中 <code>`</code> 读取后输出的还是它本身，无法直接看到 backquote 宏的名字，需要将 <code>print-pretty</code> 设置为 nil 才行 <a class="link link--text" href=https://40ants.com/lisp-hug/2017/14421.html rel=external>Quasiquote and Comma symbols</a> 。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-2-1><a class=lnlinks href=#hl-2-1> 1</a></span><span class=cl><span class=c1>;;SBCL</span>
</span></span><span class=line><span class=ln id=hl-2-2><a class=lnlinks href=#hl-2-2> 2</a></span><span class=cl><span class=c1>;; prompt is `\*&#39;</span>
</span></span><span class=line><span class=ln id=hl-2-3><a class=lnlinks href=#hl-2-3> 3</a></span><span class=cl><span class=nv>\*</span> <span class=p>(</span><span class=nf>read</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-2-4><a class=lnlinks href=#hl-2-4> 4</a></span><span class=cl><span class=o>`</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=o>,</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-2-5><a class=lnlinks href=#hl-2-5> 5</a></span><span class=cl><span class=o>`</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=o>,</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-2-6><a class=lnlinks href=#hl-2-6> 6</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-2-7><a class=lnlinks href=#hl-2-7> 7</a></span><span class=cl><span class=nv>\*</span> <span class=p>(</span><span class=nf>read</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-2-8><a class=lnlinks href=#hl-2-8> 8</a></span><span class=cl><span class=o>`</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=o>`</span><span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=mi>4</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-2-9><a class=lnlinks href=#hl-2-9> 9</a></span><span class=cl><span class=o>`</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=o>`</span><span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=mi>4</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-2-10><a class=lnlinks href=#hl-2-10>10</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-2-11><a class=lnlinks href=#hl-2-11>11</a></span><span class=cl><span class=nv>\*</span> <span class=p>(</span><span class=k>setq</span> <span class=vg>*print-pretty*</span> <span class=no>nil</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-2-12><a class=lnlinks href=#hl-2-12>12</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-2-13><a class=lnlinks href=#hl-2-13>13</a></span><span class=cl><span class=nv>\*</span> <span class=o>&#39;`</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)</span> <span class=o>,@</span><span class=p>(</span><span class=nc>list</span> <span class=mi>4</span> <span class=mi>5</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-2-14><a class=lnlinks href=#hl-2-14>14</a></span><span class=cl><span class=p>(</span><span class=nv>SB-INT:QUASIQUOTE</span>
</span></span><span class=line><span class=ln id=hl-2-15><a class=lnlinks href=#hl-2-15>15</a></span><span class=cl>   <span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=l>#S</span><span class=p>(</span><span class=nv>SB-IMPL::COMMA</span> <span class=ss>:EXPR</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)</span> <span class=ss>:KIND</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-2-16><a class=lnlinks href=#hl-2-16>16</a></span><span class=cl>        <span class=l>#S</span><span class=p>(</span><span class=nv>SB-IMPL::COMMA</span> <span class=ss>:EXPR</span> <span class=p>(</span><span class=nv>LIST</span> <span class=mi>4</span> <span class=mi>5</span><span class=p>)</span> <span class=ss>:KIND</span> <span class=mi>2</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-2-17><a class=lnlinks href=#hl-2-17>17</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-2-18><a class=lnlinks href=#hl-2-18>18</a></span><span class=cl><span class=nv>\*</span> <span class=o>&#39;`</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=o>,.</span><span class=p>(</span><span class=nc>list</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-2-19><a class=lnlinks href=#hl-2-19>19</a></span><span class=cl>    <span class=p>(</span><span class=nv>SB-INT:QUASIQUOTE</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=l>#S</span><span class=p>(</span><span class=nv>SB-IMPL::COMMA</span> <span class=ss>:EXPR</span> <span class=p>(</span><span class=nv>LIST</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)</span> <span class=ss>:KIND</span> <span class=mi>1</span><span class=p>)))</span>
</span></span></code></pre></div><p>不同的 CL 实现中 backquote 的名字不一致， ECL 中 <code>backquote</code> <code>unquote</code> 和 <code>unquote-splicing</code> 分别对应 <code>SI:QUASIQUOTE</code> ， <code>SI:UNQUOTE</code> 和 <code>SI:UNQUOTE-SPLICE</code> 。而 SBCL 中分别是 <code>SB-INT:QUASIQUOTE</code> ， <code>#S(SB-IMPL:COMMA :EXPR expr :KIND 0)</code> 和 <code>#S(SB-IMPL:COMMA :EXPR expr :KIND 2)</code> 。</p><p>总之，在 CL 中， <code>`</code> 表达式会被内部的 <code>backquote</code> 宏处理得到我们想要的结果，至于内部实现其实并不需要怎么关心。</p><h2 id=cl-标准中对于-backquote-的描述><a class=h-a href=#cl-%e6%a0%87%e5%87%86%e4%b8%ad%e5%af%b9%e4%ba%8e-backquote-%e7%9a%84%e6%8f%8f%e8%bf%b0>CL 标准中对于 backquote 的描述</a></h2><p>这一节主要是介绍一下 X3J13 在 2.4.6 节中的内容。我们可在 <a class="link link--text" href=http://www.lispworks.com/documentation/HyperSpec/Body/02_df.htm rel=external>HyperSpec</a> 浏览该文档。</p><p>根据文档上的说法， <code>backquote</code> 引入了一种用于构建数据结构的模板。使用它可以比较轻松地得到想要的内容，而不必使用各种构造函数。下面的两个表达式可看作等价的（从求值结果上来说），可把后者看作前者的宏展开结果。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-3-1><a class=lnlinks href=#hl-3-1>1</a></span><span class=cl><span class=o>`</span><span class=p>(</span><span class=nb>cond</span> <span class=p>((</span><span class=nf>numberp</span> <span class=o>,</span><span class=nv>x</span><span class=p>)</span> <span class=o>,@</span><span class=nv>y</span><span class=p>)</span> <span class=p>(</span><span class=no>t</span> <span class=p>(</span><span class=nf>print</span> <span class=o>,</span><span class=nv>x</span><span class=p>)</span> <span class=o>,@</span><span class=nv>y</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-3-2><a class=lnlinks href=#hl-3-2>2</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-3-3><a class=lnlinks href=#hl-3-3>3</a></span><span class=cl><span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;cond</span> <span class=p>(</span><span class=nc>cons</span> <span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;numberp</span> <span class=nv>x</span><span class=p>)</span> <span class=nv>y</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-3-4><a class=lnlinks href=#hl-3-4>4</a></span><span class=cl>            <span class=p>(</span><span class=nf>list*</span> <span class=ss>&#39;t</span> <span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;print</span> <span class=nv>x</span><span class=p>)</span> <span class=nv>y</span><span class=p>))</span>
</span></span></code></pre></div><p><code>backquote</code> 和 <code>quote</code> 的区别在于前者允许它接受的表达式被部分求值。通过在 <code>`</code> 作用范围内使用 <code>,</code> <code>,@</code> 或 <code>,.</code> 可将紧随的表达式的值插入对应位置。下面是一些简单的例子：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-4-1><a class=lnlinks href=#hl-4-1> 1</a></span><span class=cl><span class=c1>;;SBCL</span>
</span></span><span class=line><span class=ln id=hl-4-2><a class=lnlinks href=#hl-4-2> 2</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-4-3><a class=lnlinks href=#hl-4-3> 3</a></span><span class=cl><span class=nv>\*</span> <span class=o>`</span><span class=p>(</span><span class=mi>1</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-4-4><a class=lnlinks href=#hl-4-4> 4</a></span><span class=cl><span class=p>(</span><span class=mi>1</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-4-5><a class=lnlinks href=#hl-4-5> 5</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-4-6><a class=lnlinks href=#hl-4-6> 6</a></span><span class=cl><span class=nv>\*</span> <span class=o>`</span><span class=p>(</span><span class=mi>1</span> <span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-4-7><a class=lnlinks href=#hl-4-7> 7</a></span><span class=cl><span class=p>(</span><span class=mi>1</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-4-8><a class=lnlinks href=#hl-4-8> 8</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-4-9><a class=lnlinks href=#hl-4-9> 9</a></span><span class=cl><span class=nv>\*</span> <span class=o>`</span><span class=p>(</span><span class=mi>1</span> <span class=o>,@</span><span class=p>(</span><span class=nc>list</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-4-10><a class=lnlinks href=#hl-4-10>10</a></span><span class=cl><span class=p>(</span><span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-4-11><a class=lnlinks href=#hl-4-11>11</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-4-12><a class=lnlinks href=#hl-4-12>12</a></span><span class=cl><span class=nv>\*</span> <span class=o>`</span><span class=p>(</span><span class=mi>1</span> <span class=o>,.</span><span class=p>(</span><span class=nc>list</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-4-13><a class=lnlinks href=#hl-4-13>13</a></span><span class=cl><span class=p>(</span><span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)</span>
</span></span></code></pre></div><p><code>,</code> 表示求值并插入值， <code>,@</code> 表示求值并将结果“脱皮”（spliced）后再插入。 <code>,.</code> 和 <code>,@</code> 基本一致，不过它允许对由它得到的表结构进行带副作用的操作。下文中我基本上不会用到 <code>,.</code> ，等找到了合适的例子看能不能说一下。</p><p>下面就是对 <code>backquote</code> 展开规则的介绍了，这里基本上算是把文档翻译了一遍：</p><ol><li>对于非表非向量的表达式 <code>basic</code> ， <code>`basic</code> 和 <code>'basic</code> 一样</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-5-1><a class=lnlinks href=#hl-5-1>1</a></span><span class=cl><span class=p>(</span><span class=nf>equal</span> <span class=o>`</span><span class=nv>a</span> <span class=ss>&#39;a</span><span class=p>)</span> <span class=nv>=&gt;</span> <span class=no>t</span>
</span></span></code></pre></div><ol start=2 class=ol-continue><li>对于不以 <code>@</code> 或 <code>.</code> 开头的表达式 <code>form1</code> ， <code>`,form1</code> 就是 <code>from1</code></li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-6-1><a class=lnlinks href=#hl-6-1>1</a></span><span class=cl><span class=o>`,</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=nv>=&gt;</span> <span class=mi>3</span>
</span></span></code></pre></div><ol start=3 class=ol-continue><li><code>`,@form1</code> 的值是未定义的</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-7-1><a class=lnlinks href=#hl-7-1>1</a></span><span class=cl><span class=c1>;;ecl</span>
</span></span><span class=line><span class=ln id=hl-7-2><a class=lnlinks href=#hl-7-2>2</a></span><span class=cl><span class=o>,@</span> <span class=nb>or</span> <span class=o>,.</span> <span class=nv>has</span> <span class=nv>appeared</span> <span class=nv>in</span> <span class=nv>an</span> <span class=nv>illegal</span> <span class=nv>position.</span>
</span></span><span class=line><span class=ln id=hl-7-3><a class=lnlinks href=#hl-7-3>3</a></span><span class=cl><span class=c1>;;sbcl</span>
</span></span><span class=line><span class=ln id=hl-7-4><a class=lnlinks href=#hl-7-4>4</a></span><span class=cl><span class=o>`,@</span><span class=p>(</span><span class=nv>LIST</span> <span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)</span> <span class=nv>is</span> <span class=nf>not</span> <span class=nv>a</span> <span class=nv>well-formed</span> <span class=nv>backquote</span> <span class=nv>expression</span>
</span></span></code></pre></div><ol start=4 class=ol-continue><li><p><code>`(x1 x2 x3 ... xn . atom)</code> 可展开为 <code>(append [ x1] [ x2] [ x3] ... [ xn] (quote atom))</code></p></li><li><p><code>`(x1 x2 x3 ... xn)</code> 可展开为 <code>(append [ x1] [ x2] [ x3] ... [ xn] nil)</code></p></li><li><p><code>`(x1 x2 x3 ... . ,from)</code> 可展开为 <code>(append [ x1] [ x2] [ x3] ... [ xn] form)</code></p></li><li><p><code>`(x1 x2 x3 ... xn . ,@form)</code> 具有未定义结果</p></li><li><p><code>`#(x1 x2 x3 ... xn)</code> 可展开为 <code>(apply #'vector `(x1 x2 x3 ... xn))</code></p></li></ol><p>列表形式的 backquote 展开的关键在于对 [ xi] 的处理。</p><ul><li>① 若 <code>xi</code> 是 <code>form1</code> 形式，那么 <code>[ xi]</code> 是 <code>(list `form1)</code> ， <strong>它还需要进一步的展开</strong></li><li>② 若 <code>xi</code> 是 <code>,form1</code> 形式，那么 <code>[ xi]</code> 是 <code>(list form1)</code></li><li>③ 若 <code>xi</code> 是 <code>,@form1</code> 形式，那么 <code>[ xi]</code> 就是 <code>form1</code></li></ul><p>上面的规则解释只是文档中列出的一种，文档也说明了 CL 实现可以自由选择展开方法，只需要保证展开结果与文档标准的求值结果是 <code>equal</code> 的即可。下文中我可能有时会使用 <code>list</code> 或 <code>list*</code> 来替代 <code>append</code> ，让表达式看起来更加简单。</p><p>下面我们用一些简单的例子来观察一下一次展开得到的结果，这里使用 ECL</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-8-1><a class=lnlinks href=#hl-8-1>1</a></span><span class=cl><span class=c1>;;ECL</span>
</span></span><span class=line><span class=ln id=hl-8-2><a class=lnlinks href=#hl-8-2>2</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-8-3><a class=lnlinks href=#hl-8-3>3</a></span><span class=cl><span class=nv>CL-USER&gt;</span> <span class=p>(</span><span class=nf>macroexpand</span> <span class=o>&#39;`</span><span class=p>(</span><span class=mi>1</span> <span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-8-4><a class=lnlinks href=#hl-8-4>4</a></span><span class=cl><span class=p>(</span><span class=nv>LIST</span> <span class=mi>1</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-8-5><a class=lnlinks href=#hl-8-5>5</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-8-6><a class=lnlinks href=#hl-8-6>6</a></span><span class=cl><span class=nv>CL-USER&gt;</span> <span class=p>(</span><span class=nf>macroexpand</span> <span class=o>&#39;`</span><span class=p>(</span><span class=mi>1</span> <span class=o>,@</span><span class=p>(</span><span class=nf>list*</span> <span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span> <span class=o>&#39;</span><span class=p>(</span><span class=mi>4</span><span class=p>))</span> <span class=mi>5</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-8-7><a class=lnlinks href=#hl-8-7>7</a></span><span class=cl><span class=p>(</span><span class=nv>LIST*</span> <span class=mi>1</span> <span class=p>(</span><span class=nv>APPEND</span> <span class=p>(</span><span class=nv>LIST*</span> <span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span> <span class=o>&#39;</span><span class=p>(</span><span class=mi>4</span><span class=p>))</span> <span class=o>&#39;</span><span class=p>(</span><span class=mi>5</span><span class=p>)))</span>
</span></span></code></pre></div><p>关于 <code>backquote</code> 的嵌套，文档中简单提了句：</p><blockquote><p>If the backquote syntax is nested, the innermost backquoted form should be expanded first. This means that if several commas occur in a row, the leftmost one belongs to the innermost backquote.</p></blockquote><p>简单来说就是，如果存在嵌套的 <code>backquote</code> ， <strong>那么最内层的 backquote 应该首先得到展开。</strong> 如果多个 <code>,</code> 同时出现，那么最左边的就是最内层的。</p><p>理解了这句话就理解了嵌套 <code>backquote</code> 的求值方式。不过这一节内容已经够多了，关于它的解释我们留到下一节。下面的内容主要就是围绕规则 ① 和嵌套 <code>backquote</code> 来展开，我可能先从 Scheme（或者 racket）开始讲起，感觉它的更好理解一点。</p><p>在本节的最后留个例子当作下一节的引子吧。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-9-1><a class=lnlinks href=#hl-9-1>1</a></span><span class=cl><span class=nv>CL-USER&gt;</span> <span class=p>(</span><span class=nf>macroexpand</span> <span class=o>&#39;`</span><span class=p>(</span><span class=nf>apply</span> <span class=nf>#&#39;+</span> <span class=mi>1</span> <span class=o>,</span><span class=mi>2</span> <span class=o>`</span><span class=p>(</span><span class=mi>3</span> <span class=mi>4</span> <span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=mi>5</span> <span class=mi>6</span><span class=p>)</span> <span class=o>,,</span><span class=p>(</span><span class=nf>+</span> <span class=mi>7</span> <span class=mi>9</span><span class=p>))))</span>
</span></span><span class=line><span class=ln id=hl-9-2><a class=lnlinks href=#hl-9-2>2</a></span><span class=cl><span class=p>(</span><span class=nv>LIST</span> <span class=ss>&#39;APPLY</span> <span class=o>&#39;</span><span class=nf>#&#39;+</span> <span class=mi>1</span> <span class=mi>2</span> <span class=p>(</span><span class=nv>LIST</span> <span class=ss>&#39;LIST</span> <span class=mi>3</span> <span class=mi>4</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>5</span> <span class=mi>6</span><span class=p>)</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>7</span> <span class=mi>9</span><span class=p>)))</span>
</span></span></code></pre></div><h2 id=怎么理解嵌套的><a class=h-a href=#%e6%80%8e%e4%b9%88%e7%90%86%e8%a7%a3%e5%b5%8c%e5%a5%97%e7%9a%84>怎么理解嵌套的</a></h2><p>接下来就是本文最重要的部分了，即对于嵌套 <code>backquote</code> 的理解。由于 Scheme/Racket 中的 <code>quasiquote</code> 更好理解，所以我们先从它开始，这里参考的是 <a class="link link--text" href=http://www.r6rs.org/final/html/r6rs/r6rs-Z-H-14.html#node_idx_768 rel=external>r6rs</a>。关于简单的 backquote/unquote 上面已经举了一些例子了，这里就不说了，下面是 r6rs 关于嵌套 <code>quasiquote</code> 的解释：</p><blockquote><p>Quasiquote forms may be nested. Substitutions are made only for unquoted components appearing at the same nesting level as the outermost quasiquote. The nesting level by one inside each successive quasiquotation, and decreases by one inside each unquotation.</p></blockquote><p>这段话的意思是，对于嵌套的 <code>backquote</code> ，只有和最外层 <code>quasiquote</code> 同层次的 <code>unquote</code> 才会被求值，嵌套层次随 <code>quasiquote</code> 的出现递增，随 <code>unquote</code> 或 <code>unquote-splicing</code> 的出现递减。</p><p>r6rs 上给出了求值例子：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-10-1><a class=lnlinks href=#hl-10-1>1</a></span><span class=cl><span class=o>`</span><span class=p>(</span><span class=nv>a</span> <span class=o>`</span><span class=p>(</span><span class=nv>b</span> <span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=o>,</span><span class=p>(</span><span class=nv>foo</span> <span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>3</span><span class=p>)</span> <span class=nv>d</span><span class=p>)</span> <span class=nv>e</span><span class=p>)</span> <span class=nv>f</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-10-2><a class=lnlinks href=#hl-10-2>2</a></span><span class=cl><span class=nv>=&gt;</span> <span class=p>(</span><span class=nv>a</span> <span class=o>`</span><span class=p>(</span><span class=nv>b</span> <span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=o>,</span><span class=p>(</span><span class=nv>foo</span> <span class=mi>4</span> <span class=nv>d</span><span class=p>)</span> <span class=nv>e</span><span class=p>)</span> <span class=nv>f</span><span class=p>)</span>
</span></span></code></pre></div><p>我们可通过高亮来强调层次。这里为了方便直接用 ppt 绘图：</p><figure class="fig fig--w-text" id=fig-1><span class="img__frame img__frame--box-shadow" style="display:flex;justify-content:center;align-items:center;background-image:linear-gradient(to right,#ebeaeb,#11ed12)"><span class=img__c style=position:relative;width:100%;height:0;padding-bottom:42.0792%><img alt=image class="img--ls img--lqip lazyload" data-optimumx=auto data-sizes=auto data-srcset="/p/73c96d8f7/understand-backquote/pic.external/include-yy/1-512x.webp 512w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/1-569x.webp 569w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/1-633x.webp 633w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/1-700x.webp 700w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/1-703x.webp 703w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/1-781x.webp 781w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/1-869x.webp 869w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/1-965x.webp 965w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/1-1073x.webp 1073w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/1-1193x.webp 1193w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/1-1325x.webp 1325w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/1-1473x.webp 1473w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/1-1637x.webp 1637w, /p/73c96d8f7/understand-backquote/pic.external/include-yy/1-1820x.webp 1820w" height=295 src="data:image/webp;base64,UklGRhIDAABXRUJQVlA4IAYDAADQGgCdASrpAGIAP0WcwVWoJaOhpneZcQYoicAatYnfmMN/qB5T7nPqX20/8X6Gn0O+f/1VAF36zb8MY2I2CHelZ7rfW+RgHMsSyrmgUZTcNiY91Zv9o97GvKHH/rZdUZp8cuOUm6Xf+mujAa1zM96iMNnRZ/Rg+//F9UcyTkfRkNp64828w9OMWrCbjPk/l7R/JtP589WIJG2WiB31O+ui5sJkon4r0zkI65r6eS0+x+sqKET1j1eI9TK19Fww5t37t5H9U//9fnQvZPMHI/pg6GGsCr6FhbL96zvp0ZJgAP7qZN2bEJX7ouDqtf/d6fYtpn5YO+gOXTna2vrJa5nN2fJ4/0N+dBr+XB+TiEX/l8pnb1OaHZUl7UVMd4x95JleD+yAdNgfligNm7EdIWMgt/iH8IAAuPahiy5lu7ZRNyNH90NMKOE2mz6w6qRO5vr0wyn7ILvkSohnbcIFuuR2xmSx2oAGRvE/M6r0xTqLQ7yeIeMsnxfrON81h8+/JN148nDMTMqv/EsEt4w1Vg3X9MB+nOuC/R+5Z5AONrIKxbdvvj7OxYpez6xjjHwUQpLm+Vhl1wE/29B1MD88Y2T4qzf20AY0SvBrKeme9FW4nqRABhxaEg/5Dz44EHQoa3JplP+lzdLmSbRVB9sK0Eezrp8Xyh0gmBlEyUksArJJpcCb//joHvuJ7/r0+dH5hOF+amE4R5VeFHyOv1NwZh152zCyf41SPkJKQdB40dzBc5keCnL2Opb0VIlLwJHvcWSM4LCpIVhHLDQ3a5JVw/EB7u5p4ghyMVuxmhuhzZ6QxxSBPhpLTKDQR/tFS5upMPSI25ryPobhNW77lKyABjYcnUQ5z6eF8kIqGqu6arj1LlBOFMAAMCfpJzyQmjju6yl0xH/dnXxapMg1HCKYT1TyyRz+GEx9TgV61FtH97LTtHlQZXYpu5ey81UHYP++wBJy54Y2MGKW1nWsYQC8AxmG7exGHXdpCSlrY7l/D4u9lW0+YdDK9/eUFZR2Y54d0IFaQAAAAAA=" width=700></span></span></figure><p>可见，只有层次为 0 的 <code>unquote</code> 被求值了，它的值被放入的结果表达式中。这其实也就是我在话题开头引用的那个帖子中提到的规则：</p><ol><li>嵌套的 <code>quasiquote</code> 一次只展开一层</li><li>只替换和最外层同一层次的 <code>unquote</code></li><li>每出现一个 <code>`</code> 则层次加一，出现 <code>,</code> 或 <code>,@</code> 则层次减一</li></ol><p>这个规则非常简单易懂，但是 X3J13 中关于嵌套宏的描述就不是那么明了了。我们复述一下上个帖子中的内容：</p><ol><li>若存在 <code>backquote</code> 嵌套，那么最里面的 <code>backquote</code> 先展开</li><li>最靠左的 <code>comma</code> （也就是一系列 <code>unquote</code> ）属于最里层的 <code>backquote</code></li></ol><p>该规则的第二条和 r6rs 中的第三条是一个意思，关键在于“最里面的 <code>backquote</code> 先展开”这一规则该如何理解，它和 Scheme 规则有什么关联呢。</p><p>在具体开始之前，我们先回顾一下规则 ①：</p><ul><li>若 xi 是 form1 形式，那么 [ xi] 是 (list `form1) ，它还需要进一步的展开</li></ul><p>也就是说， <code>backquote</code> 接受的表中的非 <code>,</code> <code>,@</code> 形式的元素会进行递归式的 <code>backquote</code> 展开。举例来说的话：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-11-1><a class=lnlinks href=#hl-11-1> 1</a></span><span class=cl><span class=c1>;;SBCL</span>
</span></span><span class=line><span class=ln id=hl-11-2><a class=lnlinks href=#hl-11-2> 2</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-11-3><a class=lnlinks href=#hl-11-3> 3</a></span><span class=cl><span class=nv>CL-USER&gt;</span> <span class=p>(</span><span class=nf>macroexpand</span> <span class=o>&#39;`</span><span class=p>(((</span><span class=o>,</span><span class=nv>a</span><span class=p>))))</span>
</span></span><span class=line><span class=ln id=hl-11-4><a class=lnlinks href=#hl-11-4> 4</a></span><span class=cl><span class=p>(</span><span class=nv>LIST</span> <span class=p>(</span><span class=nv>LIST</span> <span class=p>(</span><span class=nv>LIST</span> <span class=nv>A</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-11-5><a class=lnlinks href=#hl-11-5> 5</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-11-6><a class=lnlinks href=#hl-11-6> 6</a></span><span class=cl><span class=p>(</span><span class=k>setq</span> <span class=nv>a</span> <span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-11-7><a class=lnlinks href=#hl-11-7> 7</a></span><span class=cl><span class=nv>CL-USER&gt;</span> <span class=o>`</span><span class=p>(((</span><span class=o>,</span><span class=nv>a</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-11-8><a class=lnlinks href=#hl-11-8> 8</a></span><span class=cl><span class=p>(((</span><span class=mi>1</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-11-9><a class=lnlinks href=#hl-11-9> 9</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-11-10><a class=lnlinks href=#hl-11-10>10</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-11-11><a class=lnlinks href=#hl-11-11>11</a></span><span class=cl><span class=nv>CL-USER&gt;</span> <span class=p>(</span><span class=nf>macroexpand</span> <span class=o>&#39;`</span><span class=p>(</span><span class=mi>1</span> <span class=p>(</span><span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))</span> <span class=p>((</span><span class=mi>4</span> <span class=mi>5</span><span class=p>))))</span>
</span></span><span class=line><span class=ln id=hl-11-12><a class=lnlinks href=#hl-11-12>12</a></span><span class=cl><span class=p>(</span><span class=nv>LIST*</span> <span class=mi>1</span> <span class=p>(</span><span class=nv>LIST</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))</span> <span class=p>(</span><span class=nv>QUOTE</span> <span class=p>(((</span><span class=mi>4</span> <span class=mi>5</span><span class=p>)))))</span>
</span></span><span class=line><span class=ln id=hl-11-13><a class=lnlinks href=#hl-11-13>13</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-11-14><a class=lnlinks href=#hl-11-14>14</a></span><span class=cl><span class=nv>CL-USER&gt;</span> <span class=o>`</span><span class=p>(</span><span class=mi>1</span> <span class=p>(</span><span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))</span> <span class=p>((</span><span class=mi>4</span> <span class=mi>5</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-11-15><a class=lnlinks href=#hl-11-15>15</a></span><span class=cl><span class=p>(</span><span class=mi>1</span> <span class=p>(</span><span class=mi>5</span><span class=p>)</span> <span class=p>((</span><span class=mi>4</span> <span class=mi>5</span><span class=p>)))</span>
</span></span></code></pre></div><p>CL 实现或多或少采用了自己的方法实现 <code>backquote</code> ，在展开过程中可能简化了一些表达式，所以上面得到的展开结果和标准中的不一致。拿上面的 <code>`(((,a)))</code> 来举例，我们用上一节描述的标准规则进行展开。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-12-1><a class=lnlinks href=#hl-12-1>1</a></span><span class=cl><span class=p>(</span><span class=nf>macroexpand</span> <span class=o>&#39;`</span><span class=p>(((</span><span class=o>,</span><span class=nv>a</span><span class=p>))))</span>
</span></span><span class=line><span class=ln id=hl-12-2><a class=lnlinks href=#hl-12-2>2</a></span><span class=cl><span class=nv>=&gt;</span> <span class=p>(</span><span class=nf>append</span> <span class=p>(</span><span class=nc>list</span> <span class=o>`</span><span class=p>((</span><span class=o>,</span><span class=nv>a</span><span class=p>)))</span> <span class=no>nil</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-12-3><a class=lnlinks href=#hl-12-3>3</a></span><span class=cl><span class=nv>=&gt;</span> <span class=p>(</span><span class=nf>append</span> <span class=p>(</span><span class=nc>list</span> <span class=p>(</span><span class=nf>append</span> <span class=p>(</span><span class=nc>list</span> <span class=o>`</span><span class=p>(</span><span class=o>,</span><span class=nv>a</span><span class=p>))</span> <span class=no>nil</span><span class=p>))</span> <span class=no>nil</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-12-4><a class=lnlinks href=#hl-12-4>4</a></span><span class=cl><span class=nv>=&gt;</span> <span class=p>(</span><span class=nf>append</span> <span class=p>(</span><span class=nc>list</span> <span class=p>(</span><span class=nf>append</span> <span class=p>(</span><span class=nc>list</span> <span class=p>(</span><span class=nf>append</span> <span class=p>(</span><span class=nc>list</span> <span class=nv>a</span><span class=p>)</span> <span class=no>nil</span><span class=p>))</span> <span class=no>nil</span><span class=p>))</span> <span class=no>nil</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-12-5><a class=lnlinks href=#hl-12-5>5</a></span><span class=cl><span class=p>(</span><span class=k>setq</span> <span class=nv>a</span> <span class=ss>&#39;a</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-12-6><a class=lnlinks href=#hl-12-6>6</a></span><span class=cl><span class=o>`</span><span class=p>(((</span><span class=o>,</span><span class=nv>a</span><span class=p>)))</span> <span class=nv>=&gt;</span> <span class=p>(((</span><span class=nv>a</span><span class=p>)))</span>
</span></span></code></pre></div><p>根据嵌套 <code>backquote</code> 先展开内部的原则，我们使用下面的例子尝试一下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-13-1><a class=lnlinks href=#hl-13-1> 1</a></span><span class=cl><span class=o>``</span><span class=p>(</span><span class=nv>b</span> <span class=o>,</span><span class=nv>c</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-13-2><a class=lnlinks href=#hl-13-2> 2</a></span><span class=cl><span class=nv>=&gt;</span> <span class=o>`</span><span class=p>(</span><span class=nf>append</span> <span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;b</span><span class=p>)</span> <span class=p>(</span><span class=nc>list</span> <span class=nv>c</span><span class=p>)</span> <span class=no>nil</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-13-3><a class=lnlinks href=#hl-13-3> 3</a></span><span class=cl><span class=nv>=&gt;</span> <span class=p>(</span><span class=nf>append</span> <span class=p>(</span><span class=nc>list</span> <span class=o>`</span><span class=nf>append</span><span class=p>)</span> <span class=p>(</span><span class=nc>list</span> <span class=o>`</span><span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;b</span><span class=p>))</span> <span class=p>(</span><span class=nc>list</span> <span class=o>`</span><span class=p>(</span><span class=nc>list</span> <span class=nv>c</span><span class=p>))</span> <span class=p>(</span><span class=nc>list</span> <span class=o>`</span><span class=no>nil</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-13-4><a class=lnlinks href=#hl-13-4> 4</a></span><span class=cl><span class=nv>=&gt;</span> <span class=p>(</span><span class=nf>append</span> <span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;append</span><span class=p>)</span> <span class=p>(</span><span class=nc>list</span> <span class=p>(</span><span class=nf>append</span> <span class=p>(</span><span class=nc>list</span> <span class=o>`</span><span class=nc>list</span><span class=p>)</span> <span class=p>(</span><span class=nc>list</span> <span class=o>`</span><span class=ss>&#39;b</span><span class=p>)</span> <span class=no>nil</span><span class=p>))</span> <span class=p>(</span><span class=nc>list</span> <span class=p>(</span><span class=nf>append</span> <span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;list</span><span class=p>)</span> <span class=p>(</span><span class=nc>list</span> <span class=o>`</span><span class=nv>c</span><span class=p>)</span> <span class=no>nil</span><span class=p>))</span> <span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;nil</span><span class=p>)</span> <span class=no>nil</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-13-5><a class=lnlinks href=#hl-13-5> 5</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-13-6><a class=lnlinks href=#hl-13-6> 6</a></span><span class=cl><span class=p>(</span><span class=nf>append</span> <span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;append</span><span class=p>)</span> <span class=p>(</span><span class=nc>list</span> <span class=p>(</span><span class=nf>append</span> <span class=p>(</span><span class=nc>list</span> <span class=o>`</span><span class=nc>list</span><span class=p>)</span> <span class=p>(</span><span class=nc>list</span> <span class=o>`</span><span class=ss>&#39;b</span><span class=p>)</span> <span class=no>nil</span><span class=p>))</span> <span class=p>(</span><span class=nc>list</span> <span class=p>(</span><span class=nf>append</span> <span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;list</span><span class=p>)</span> <span class=p>(</span><span class=nc>list</span> <span class=o>`</span><span class=nv>c</span><span class=p>)</span> <span class=no>nil</span><span class=p>))</span> <span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;nil</span><span class=p>)</span> <span class=no>nil</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-13-7><a class=lnlinks href=#hl-13-7> 7</a></span><span class=cl><span class=nv>=&gt;</span> <span class=p>(</span><span class=nf>append</span> <span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;b</span><span class=p>)</span> <span class=p>(</span><span class=nc>list</span> <span class=nv>c</span><span class=p>)</span> <span class=no>nil</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-13-8><a class=lnlinks href=#hl-13-8> 8</a></span><span class=cl><span class=p>(</span><span class=k>setq</span> <span class=nv>b</span> <span class=mi>1</span> <span class=nv>c</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-13-9><a class=lnlinks href=#hl-13-9> 9</a></span><span class=cl><span class=p>(</span><span class=nf>append</span> <span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;b</span><span class=p>)</span> <span class=p>(</span><span class=nc>list</span> <span class=nv>c</span><span class=p>)</span> <span class=no>nil</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-13-10><a class=lnlinks href=#hl-13-10>10</a></span><span class=cl><span class=nv>=&gt;</span> <span class=p>(</span><span class=nv>b</span> <span class=mi>2</span><span class=p>)</span>
</span></span></code></pre></div><p>所谓的最内层最先展开就是这样做的，最内层最先展开也就意味着最外层最先求值。这个规则的另一种描述就是 Scheme 规则的第一条和第二条，使用 Scheme 规则显然更利于理解。对 <code></code>(b ,c) <code>的第一次求值得到</code> <code>(b ,c) `` ，对结果再求值就可得 </code>(b 2)` 了。</p><p>这里附上一种 <code>backquote</code> 的实现方法：Appendix C. Backquote<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup> ，下文中提到的参考均指它。</p><p>关于嵌套 <code>backquote</code> 的原理基本上就讲的差不多了，接下来的内容主要介绍一些嵌套 <code>unquote</code> 的用法。这里先用个例子做引子吧：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-14-1><a class=lnlinks href=#hl-14-1>1</a></span><span class=cl><span class=c1>;;SBCL</span>
</span></span><span class=line><span class=ln id=hl-14-2><a class=lnlinks href=#hl-14-2>2</a></span><span class=cl><span class=p>(</span><span class=k>setq</span> <span class=nv>a</span> <span class=o>&#39;</span><span class=p>((</span><span class=nc>list</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=p>(</span><span class=nc>list</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-14-3><a class=lnlinks href=#hl-14-3>3</a></span><span class=cl><span class=p>(</span><span class=k>setq</span> <span class=vg>*print-pretty*</span> <span class=no>t</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-14-4><a class=lnlinks href=#hl-14-4>4</a></span><span class=cl><span class=nv>CL-USER&gt;</span> <span class=o>``</span><span class=p>(</span><span class=o>,@,@</span><span class=nv>a</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-14-5><a class=lnlinks href=#hl-14-5>5</a></span><span class=cl><span class=o>`</span><span class=p>(</span><span class=o>,@</span><span class=p>(</span><span class=nv>LIST</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=o>,@</span><span class=p>(</span><span class=nv>LIST</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-14-6><a class=lnlinks href=#hl-14-6>6</a></span><span class=cl><span class=nv>CL-USER&gt;</span> <span class=o>`</span><span class=p>(</span><span class=o>,@</span><span class=p>(</span><span class=nv>LIST</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=o>,@</span><span class=p>(</span><span class=nv>LIST</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-14-7><a class=lnlinks href=#hl-14-7>7</a></span><span class=cl><span class=p>(</span><span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>)</span>
</span></span></code></pre></div><h2 id=几种常见的嵌套-backquote-组合><a class=h-a href=#%e5%87%a0%e7%a7%8d%e5%b8%b8%e8%a7%81%e7%9a%84%e5%b5%8c%e5%a5%97-backquote-%e7%bb%84%e5%90%88>几种常见的嵌套 backquote 组合</a></h2><p>要拿排列组合来说的话， <code>,</code> 和 <code>,@</code> 的两两组合只有四种，再加上中间可能出现的 <code>'</code> ，那也就只有八种而已。更多的嵌套只不过是从这几种继续堆叠。所以弄清楚了二重嵌套就差不多弄清了其他更复杂的嵌套。</p><h3 id=-><a class=h-a href=#->① <code>,,</code></a></h3><p>这应该是最容易想到的嵌套方法，两个 <code>,</code> 表示每消掉一层 <code>`</code> 都对 <code>,</code> 作用的表达式求值一次，就像这样：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-15-1><a class=lnlinks href=#hl-15-1>1</a></span><span class=cl><span class=o>``</span><span class=p>(</span><span class=o>,,</span><span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-15-2><a class=lnlinks href=#hl-15-2>2</a></span><span class=cl><span class=nv>=&gt;</span> <span class=o>`</span><span class=p>(</span><span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-15-3><a class=lnlinks href=#hl-15-3>3</a></span><span class=cl><span class=nv>=&gt;</span> <span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span></code></pre></div><p>我对 emacs27 的 elisp 源文件使用了 <code>git grep ,,</code> 搜索，这种用法在宏中好像不多，我好像只在 ert.el 和 radix-tree.el 中看到了这种用法。有兴趣的同学可以去看看。</p><h3 id=--1><a class=h-a href=#--1>② <code>,',</code></a></h3><p>这种用法表示展开外层 <code>`</code> 时对内层求值，在展开内层 <code>`</code> 时对上一次求值结果的 <code>quote</code> 形式求值，从而相当于只在外层展开时求值。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-16-1><a class=lnlinks href=#hl-16-1>1</a></span><span class=cl><span class=o>``</span><span class=p>(</span><span class=o>,</span><span class=ss>&#39;,</span><span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-16-2><a class=lnlinks href=#hl-16-2>2</a></span><span class=cl><span class=nv>=&gt;</span> <span class=o>`</span><span class=p>(</span><span class=o>,&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-16-3><a class=lnlinks href=#hl-16-3>3</a></span><span class=cl><span class=nv>=&gt;</span> <span class=p>((</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span>
</span></span></code></pre></div><p>这种用法可以在 gv.el 中找到，这里我举个简单的例子，假设我们需要定义得到对符号加减乘除的表达式的宏</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-17-1><a class=lnlinks href=#hl-17-1>1</a></span><span class=cl><span class=p>(</span><span class=nb>defmacro</span> <span class=nv>madd</span> <span class=p>(</span><span class=nv>sm</span> <span class=nv>num</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-17-2><a class=lnlinks href=#hl-17-2>2</a></span><span class=cl>  <span class=o>`</span><span class=p>(</span><span class=k>setq</span> <span class=o>,</span><span class=nv>sm</span> <span class=p>(</span><span class=nf>+</span> <span class=o>,</span><span class=nv>sm</span> <span class=o>,</span><span class=nv>num</span><span class=p>)))</span>
</span></span></code></pre></div><p>假设我们想要创建一个创建这种宏的宏，我们可以让宏的名字和操作符作为生成宏的参数：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-18-1><a class=lnlinks href=#hl-18-1>1</a></span><span class=cl><span class=p>(</span><span class=nb>defmacro</span> <span class=nv>m-op</span> <span class=p>(</span><span class=nv>name</span> <span class=nv>op</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-18-2><a class=lnlinks href=#hl-18-2>2</a></span><span class=cl>  <span class=o>`</span><span class=p>(</span><span class=nb>defmacro</span> <span class=o>,</span><span class=nv>name</span> <span class=p>(</span><span class=nv>sm</span> <span class=nv>arg</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-18-3><a class=lnlinks href=#hl-18-3>3</a></span><span class=cl>     <span class=o>`</span><span class=p>(</span><span class=k>setq</span> <span class=o>,</span><span class=nv>sm</span> <span class=p>(</span><span class=o>,</span><span class=ss>&#39;,op</span> <span class=o>,</span><span class=nv>sm</span> <span class=o>,</span><span class=nv>arg</span><span class=p>))))</span>
</span></span><span class=line><span class=ln id=hl-18-4><a class=lnlinks href=#hl-18-4>4</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-18-5><a class=lnlinks href=#hl-18-5>5</a></span><span class=cl><span class=p>(</span><span class=nf>macroexpand</span> <span class=o>&#39;</span><span class=p>(</span><span class=nv>m-op</span> <span class=nv>abc</span> <span class=nf>+</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-18-6><a class=lnlinks href=#hl-18-6>6</a></span><span class=cl><span class=nv>=&gt;</span> <span class=p>(</span><span class=nv>defalias</span> <span class=ss>&#39;abc</span> <span class=p>(</span><span class=nc>cons</span> <span class=ss>&#39;macro</span> <span class=nf>#&#39;</span><span class=p>(</span><span class=nb>lambda</span> <span class=p>(</span><span class=nv>sm</span> <span class=nv>arg</span><span class=p>)</span> <span class=o>`</span><span class=p>(</span><span class=k>setq</span> <span class=o>,</span><span class=nv>sm</span> <span class=p>(</span><span class=o>,</span><span class=ss>&#39;+</span> <span class=o>,</span><span class=nv>sm</span> <span class=o>,</span><span class=nv>arg</span><span class=p>)))))</span>
</span></span><span class=line><span class=ln id=hl-18-7><a class=lnlinks href=#hl-18-7>7</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-18-8><a class=lnlinks href=#hl-18-8>8</a></span><span class=cl><span class=p>(</span><span class=k>setq</span> <span class=nv>a</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-18-9><a class=lnlinks href=#hl-18-9>9</a></span><span class=cl><span class=p>(</span><span class=nv>abc</span> <span class=nv>a</span> <span class=mi>2</span><span class=p>)</span> <span class=nv>=&gt;</span> <span class=mi>4</span>
</span></span></code></pre></div><h3 id=--和-><a class=h-a href=#--%e5%92%8c->③ <code>,@,</code> 和 <code>,@',</code></a></h3><p>这种用法表示先求值后展平，就像这样：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-19-1><a class=lnlinks href=#hl-19-1>1</a></span><span class=cl><span class=o>``</span><span class=p>(</span><span class=o>,@,</span><span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;list</span> <span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-19-2><a class=lnlinks href=#hl-19-2>2</a></span><span class=cl><span class=nv>=&gt;</span> <span class=o>`</span><span class=p>(</span><span class=o>,@</span><span class=p>(</span><span class=nc>list</span> <span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-19-3><a class=lnlinks href=#hl-19-3>3</a></span><span class=cl><span class=nv>=&gt;</span> <span class=p>(</span><span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)</span>
</span></span></code></pre></div><p>至于 <code>,@',</code> ，它和上面的 <code>,',</code> 类似，也相当于只在外层 <code>`</code> 展开时进行一次求值</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-20-1><a class=lnlinks href=#hl-20-1>1</a></span><span class=cl><span class=o>``</span><span class=p>(</span><span class=o>,@</span><span class=ss>&#39;,</span><span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;list</span> <span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-20-2><a class=lnlinks href=#hl-20-2>2</a></span><span class=cl><span class=nv>=&gt;</span> <span class=o>`</span><span class=p>(</span><span class=o>,@&#39;</span><span class=p>(</span><span class=nc>list</span> <span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-20-3><a class=lnlinks href=#hl-20-3>3</a></span><span class=cl><span class=nv>=&gt;</span> <span class=p>(</span><span class=nc>list</span> <span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)</span>
</span></span></code></pre></div><p>这种用法我在 emacs 代码中貌似搜索不到……</p><p>上一节的最后我举了一个使用 <code>,@,@</code> 嵌套的例子，它在 elisp 里面是行不通的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elisp data-lang=elisp><span class=line><span class=ln id=hl-21-1><a class=lnlinks href=#hl-21-1>1</a></span><span class=cl><span class=p>(</span><span class=nb>setq</span> <span class=nv>a</span> <span class=o>&#39;</span><span class=p>((</span><span class=nf>list</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=p>(</span><span class=nf>list</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-21-2><a class=lnlinks href=#hl-21-2>2</a></span><span class=cl><span class=o>``</span><span class=p>(</span><span class=o>,@,@</span><span class=nv>a</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-21-3><a class=lnlinks href=#hl-21-3>3</a></span><span class=cl><span class=nv>=&gt;</span> <span class=o>`</span><span class=p>((</span><span class=nv>\,@</span> <span class=p>(</span><span class=nf>list</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=p>(</span><span class=nf>list</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>)))</span>
</span></span></code></pre></div><p>可见外层的 <code>,@</code> 并未作用到内层展开得到的所有项上，这与 emacs 中的实现有关。</p><h3 id=--和--1><a class=h-a href=#--%e5%92%8c--1>④ <code>,,@</code> 和 <code>,',@</code></a></h3><p><code>,,@</code> 表示先展平，后对展平的 <strong>各项</strong> 求值：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-22-1><a class=lnlinks href=#hl-22-1>1</a></span><span class=cl><span class=c1>;;SBCL</span>
</span></span><span class=line><span class=ln id=hl-22-2><a class=lnlinks href=#hl-22-2>2</a></span><span class=cl><span class=nv>\*</span> <span class=o>``</span><span class=p>(</span><span class=o>,,@</span><span class=p>(</span><span class=nc>list</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-22-3><a class=lnlinks href=#hl-22-3>3</a></span><span class=cl><span class=o>`</span><span class=p>(</span><span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-22-4><a class=lnlinks href=#hl-22-4>4</a></span><span class=cl><span class=nv>\*</span> <span class=o>`</span><span class=p>(</span><span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-22-5><a class=lnlinks href=#hl-22-5>5</a></span><span class=cl><span class=p>(</span><span class=mi>3</span> <span class=mi>5</span><span class=p>)</span>
</span></span></code></pre></div><p><code>,',@</code> 类似于上面 ③ 中加 <code>'</code> 的情况，但要注意 <code>,@</code> 得到的结果只能有一项，否则就会出错：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-23-1><a class=lnlinks href=#hl-23-1> 1</a></span><span class=cl><span class=c1>;;SBCL</span>
</span></span><span class=line><span class=ln id=hl-23-2><a class=lnlinks href=#hl-23-2> 2</a></span><span class=cl><span class=nv>\*</span> <span class=o>``</span><span class=p>(</span><span class=o>,</span><span class=ss>&#39;,@</span><span class=p>(</span><span class=nc>list</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-23-3><a class=lnlinks href=#hl-23-3> 3</a></span><span class=cl><span class=o>`</span><span class=p>(</span><span class=o>,&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-23-4><a class=lnlinks href=#hl-23-4> 4</a></span><span class=cl><span class=nv>\*</span> <span class=o>`</span><span class=p>(</span><span class=o>,&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-23-5><a class=lnlinks href=#hl-23-5> 5</a></span><span class=cl><span class=p>((</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-23-6><a class=lnlinks href=#hl-23-6> 6</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-23-7><a class=lnlinks href=#hl-23-7> 7</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-23-8><a class=lnlinks href=#hl-23-8> 8</a></span><span class=cl><span class=nv>\*</span> <span class=o>``</span><span class=p>(</span><span class=o>,</span><span class=ss>&#39;,@</span><span class=p>(</span><span class=nc>list</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-23-9><a class=lnlinks href=#hl-23-9> 9</a></span><span class=cl><span class=o>`</span><span class=p>(</span><span class=o>,</span><span class=p>(</span><span class=nv>QUOTE</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-23-10><a class=lnlinks href=#hl-23-10>10</a></span><span class=cl><span class=nv>\*</span> <span class=o>`</span><span class=p>(</span><span class=o>,</span><span class=p>(</span><span class=nv>QUOTE</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-23-11><a class=lnlinks href=#hl-23-11>11</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-23-12><a class=lnlinks href=#hl-23-12>12</a></span><span class=cl><span class=nv>debugger</span> <span class=nv>invoked</span> <span class=nv>on</span> <span class=nv>a</span> <span class=nv>SIMPLE-ERROR</span> <span class=nv>in</span> <span class=nv>thread</span>
</span></span><span class=line><span class=ln id=hl-23-13><a class=lnlinks href=#hl-23-13>13</a></span><span class=cl><span class=err>#</span><span class=nv>&lt;THREAD</span> <span class=s>&#34;main thread&#34;</span> <span class=nv>RUNNING</span> <span class=nv>{10010B0523}&gt;:</span>
</span></span><span class=line><span class=ln id=hl-23-14><a class=lnlinks href=#hl-23-14>14</a></span><span class=cl>  <span class=nv>wrong</span> <span class=nc>number</span> <span class=nv>of</span> <span class=nv>args</span> <span class=nv>to</span> <span class=nv>QUOTE:</span>
</span></span><span class=line><span class=ln id=hl-23-15><a class=lnlinks href=#hl-23-15>15</a></span><span class=cl> <span class=p>(</span><span class=nv>QUOTE</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))</span>
</span></span></code></pre></div><h3 id=--和--2><a class=h-a href=#--%e5%92%8c--2>⑤ <code>,@,@</code> 和 <code>,@',@</code></a></h3><p><code>,@,@</code> 表示进行二次展平， <code>,@',@</code> 和 <code>,',@</code> 类似，后一 <code>,@</code> 展开得到的结果只能有一项：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-24-1><a class=lnlinks href=#hl-24-1> 1</a></span><span class=cl><span class=c1>;;SBCL</span>
</span></span><span class=line><span class=ln id=hl-24-2><a class=lnlinks href=#hl-24-2> 2</a></span><span class=cl><span class=nv>\*</span> <span class=o>``</span><span class=p>(</span><span class=o>,@,@</span><span class=p>(</span><span class=nc>list</span> <span class=o>&#39;</span><span class=p>(</span><span class=nc>list</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=o>&#39;</span><span class=p>(</span><span class=nc>list</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-24-3><a class=lnlinks href=#hl-24-3> 3</a></span><span class=cl><span class=o>`</span><span class=p>(</span><span class=o>,@</span><span class=p>(</span><span class=nv>LIST</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=o>,@</span><span class=p>(</span><span class=nv>LIST</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-24-4><a class=lnlinks href=#hl-24-4> 4</a></span><span class=cl><span class=nv>\*</span> <span class=o>`</span><span class=p>(</span><span class=o>,@</span><span class=p>(</span><span class=nv>LIST</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=o>,@</span><span class=p>(</span><span class=nv>LIST</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-24-5><a class=lnlinks href=#hl-24-5> 5</a></span><span class=cl><span class=p>(</span><span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-24-6><a class=lnlinks href=#hl-24-6> 6</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-24-7><a class=lnlinks href=#hl-24-7> 7</a></span><span class=cl><span class=nv>\*</span> <span class=o>``</span><span class=p>(</span><span class=o>,@</span><span class=ss>&#39;,@</span><span class=p>(</span><span class=nc>list</span> <span class=o>&#39;</span><span class=p>(</span><span class=nc>list</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-24-8><a class=lnlinks href=#hl-24-8> 8</a></span><span class=cl><span class=o>`</span><span class=p>(</span><span class=o>,@&#39;</span><span class=p>(</span><span class=nv>LIST</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-24-9><a class=lnlinks href=#hl-24-9> 9</a></span><span class=cl><span class=nv>\*</span> <span class=o>`</span><span class=p>(</span><span class=o>,@&#39;</span><span class=p>(</span><span class=nv>LIST</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-24-10><a class=lnlinks href=#hl-24-10>10</a></span><span class=cl><span class=p>(</span><span class=nv>LIST</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span>
</span></span></code></pre></div><p>对于 ④ 和 ⑤ ，elisp 中都无法得到令人满意的结果，这是由于 elisp 的 <code>backquote</code> 不符合 CL 标准而导致的，在上上节的链接中，作者这样说到：</p><blockquote><p>the rules given here work, but some Common Lisp implementations have run into trouble at one time or another by using a simplification rule that does not work in all cases.</p></blockquote><div class=highlight><pre tabindex=0 class=chroma><code class=language-elisp data-lang=elisp><span class=line><span class=ln id=hl-25-1><a class=lnlinks href=#hl-25-1> 1</a></span><span class=cl><span class=c1>;;elisp</span>
</span></span><span class=line><span class=ln id=hl-25-2><a class=lnlinks href=#hl-25-2> 2</a></span><span class=cl><span class=o>``</span><span class=p>(</span><span class=o>,,@</span><span class=p>(</span><span class=nf>list</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-25-3><a class=lnlinks href=#hl-25-3> 3</a></span><span class=cl><span class=nv>=&gt;</span> <span class=o>`</span><span class=p>((</span><span class=nv>\,</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-25-4><a class=lnlinks href=#hl-25-4> 4</a></span><span class=cl><span class=nv>=&gt;</span> <span class=ne>error</span> <span class=s>&#34;Multiple args to , are not supported&#34;</span>
</span></span><span class=line><span class=ln id=hl-25-5><a class=lnlinks href=#hl-25-5> 5</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-25-6><a class=lnlinks href=#hl-25-6> 6</a></span><span class=cl><span class=o>``</span><span class=p>(</span><span class=o>,,@</span><span class=p>(</span><span class=nf>list</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-25-7><a class=lnlinks href=#hl-25-7> 7</a></span><span class=cl><span class=nv>=&gt;</span> <span class=o>`</span><span class=p>(</span><span class=o>,</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-25-8><a class=lnlinks href=#hl-25-8> 8</a></span><span class=cl><span class=nv>=&gt;</span> <span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-25-9><a class=lnlinks href=#hl-25-9> 9</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-25-10><a class=lnlinks href=#hl-25-10>10</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-25-11><a class=lnlinks href=#hl-25-11>11</a></span><span class=cl><span class=o>``</span><span class=p>(</span><span class=o>,@,@</span><span class=p>(</span><span class=nf>list</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>list</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>list</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-25-12><a class=lnlinks href=#hl-25-12>12</a></span><span class=cl><span class=nv>=&gt;</span> <span class=o>`</span><span class=p>((</span><span class=nv>\,@</span> <span class=p>(</span><span class=nf>list</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=p>(</span><span class=nf>list</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-25-13><a class=lnlinks href=#hl-25-13>13</a></span><span class=cl><span class=nv>=&gt;</span> <span class=ne>error</span>
</span></span><span class=line><span class=ln id=hl-25-14><a class=lnlinks href=#hl-25-14>14</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-25-15><a class=lnlinks href=#hl-25-15>15</a></span><span class=cl><span class=o>``</span><span class=p>(</span><span class=o>,@,@</span><span class=p>(</span><span class=nf>list</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>list</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-25-16><a class=lnlinks href=#hl-25-16>16</a></span><span class=cl><span class=nv>=&gt;</span> <span class=o>`</span><span class=p>(</span><span class=o>,@</span><span class=p>(</span><span class=nf>list</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-25-17><a class=lnlinks href=#hl-25-17>17</a></span><span class=cl><span class=nv>=&gt;</span> <span class=p>(</span><span class=mi>1</span> <span class=mi>2</span><span class=p>)</span>
</span></span></code></pre></div><p>按照 CL 标准，上面的各表达式展开结果应该是这样的（方便起见，这里就只展开最里层说明一下）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-26-1><a class=lnlinks href=#hl-26-1>1</a></span><span class=cl><span class=o>``</span><span class=p>(</span><span class=o>,,@</span><span class=p>(</span><span class=nc>list</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-26-2><a class=lnlinks href=#hl-26-2>2</a></span><span class=cl><span class=o>`</span><span class=p>(</span><span class=nf>append</span> <span class=p>(</span><span class=nc>list</span> <span class=o>,@</span><span class=p>(</span><span class=nc>list</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>)))</span> <span class=no>nil</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-26-3><a class=lnlinks href=#hl-26-3>3</a></span><span class=cl><span class=p>(</span><span class=nf>eval</span> <span class=nv>it</span><span class=p>)</span> <span class=nv>=&gt;</span> <span class=p>(</span><span class=nf>append</span> <span class=p>(</span><span class=nc>list</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>))</span> <span class=no>nil</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-26-4><a class=lnlinks href=#hl-26-4>4</a></span><span class=cl><span class=p>(</span><span class=nf>eval</span> <span class=nv>it</span><span class=p>)</span> <span class=nv>=&gt;</span> <span class=p>(</span><span class=mi>3</span> <span class=mi>7</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-26-5><a class=lnlinks href=#hl-26-5>5</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-26-6><a class=lnlinks href=#hl-26-6>6</a></span><span class=cl><span class=o>``</span><span class=p>(</span><span class=o>,@,@</span><span class=p>(</span><span class=nc>list</span> <span class=o>&#39;</span><span class=p>(</span><span class=nc>list</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=o>&#39;</span><span class=p>(</span><span class=nc>list</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-26-7><a class=lnlinks href=#hl-26-7>7</a></span><span class=cl><span class=o>`</span><span class=p>(</span><span class=nf>append</span> <span class=o>,@</span><span class=p>(</span><span class=nc>list</span> <span class=o>&#39;</span><span class=p>(</span><span class=nc>list</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=o>&#39;</span><span class=p>(</span><span class=nc>list</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>))</span> <span class=no>nil</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-26-8><a class=lnlinks href=#hl-26-8>8</a></span><span class=cl><span class=p>(</span><span class=nf>eval</span> <span class=nv>it</span><span class=p>)</span> <span class=nv>=&gt;</span> <span class=p>(</span><span class=nf>append</span> <span class=p>(</span><span class=nc>list</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=p>(</span><span class=nc>list</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>)</span> <span class=no>nil</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-26-9><a class=lnlinks href=#hl-26-9>9</a></span><span class=cl><span class=p>(</span><span class=nf>eval</span> <span class=nv>it</span><span class=p>)</span> <span class=nv>=&gt;</span> <span class=p>(</span><span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span> <span class=mi>4</span><span class=p>)</span>
</span></span></code></pre></div><h3 id=cl-中-backquote-的一个极简实现><a class=h-a href=#cl-%e4%b8%ad-backquote-%e7%9a%84%e4%b8%80%e4%b8%aa%e6%9e%81%e7%ae%80%e5%ae%9e%e7%8e%b0>CL 中 backquote 的一个极简实现</a></h3><p>本节剩下的内容是对 CL 实现的一个简单分析，此处的实现参考了上面给出的链接中的实现，出于简单考虑，我没有对展开时进行化简，且没有实现 <code>,.</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-27-1><a class=lnlinks href=#hl-27-1> 1</a></span><span class=cl><span class=c1>;; ec$  即 backuqote</span>
</span></span><span class=line><span class=ln id=hl-27-2><a class=lnlinks href=#hl-27-2> 2</a></span><span class=cl><span class=c1>;; ec%  即 unquote</span>
</span></span><span class=line><span class=ln id=hl-27-3><a class=lnlinks href=#hl-27-3> 3</a></span><span class=cl><span class=c1>;; ec%@ 即 unquote-splicing</span>
</span></span><span class=line><span class=ln id=hl-27-4><a class=lnlinks href=#hl-27-4> 4</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-27-5><a class=lnlinks href=#hl-27-5> 5</a></span><span class=cl><span class=p>(</span><span class=nb>defmacro</span> <span class=nv>ec$</span> <span class=p>(</span><span class=nv>x</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-27-6><a class=lnlinks href=#hl-27-6> 6</a></span><span class=cl>  <span class=s>&#34;the backquote macro
</span></span></span><span class=line><span class=ln id=hl-27-7><a class=lnlinks href=#hl-27-7> 7</a></span><span class=cl><span class=s>ec means emacs-china, bk means backquote&#34;</span>
</span></span><span class=line><span class=ln id=hl-27-8><a class=lnlinks href=#hl-27-8> 8</a></span><span class=cl>  <span class=p>(</span><span class=nv>ec-bk-process</span> <span class=nv>x</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-27-9><a class=lnlinks href=#hl-27-9> 9</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-27-10><a class=lnlinks href=#hl-27-10>10</a></span><span class=cl><span class=p>(</span><span class=nb>defun</span> <span class=nv>ec-bk-process</span> <span class=p>(</span><span class=nv>x</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-27-11><a class=lnlinks href=#hl-27-11>11</a></span><span class=cl>  <span class=p>(</span><span class=nb>cond</span>
</span></span><span class=line><span class=ln id=hl-27-12><a class=lnlinks href=#hl-27-12>12</a></span><span class=cl>    <span class=p>((</span><span class=kt>atom</span> <span class=nv>x</span><span class=p>)</span> <span class=c1>;;原子类型直接用 quote</span>
</span></span><span class=line><span class=ln id=hl-27-13><a class=lnlinks href=#hl-27-13>13</a></span><span class=cl>     <span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;quote</span> <span class=nv>x</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-27-14><a class=lnlinks href=#hl-27-14>14</a></span><span class=cl>    <span class=p>((</span><span class=nf>eq</span> <span class=p>(</span><span class=nf>car</span> <span class=nv>x</span><span class=p>)</span> <span class=ss>&#39;ec$</span><span class=p>)</span> <span class=c1>;;嵌套 ` 处理，即递归处理，先从最里层开始</span>
</span></span><span class=line><span class=ln id=hl-27-15><a class=lnlinks href=#hl-27-15>15</a></span><span class=cl>     <span class=p>(</span><span class=nv>ec-bk-process</span> <span class=p>(</span><span class=nv>ec-bk-process</span> <span class=p>(</span><span class=nf>cadr</span> <span class=nv>x</span><span class=p>))))</span>
</span></span><span class=line><span class=ln id=hl-27-16><a class=lnlinks href=#hl-27-16>16</a></span><span class=cl>    <span class=p>((</span><span class=nf>eq</span> <span class=p>(</span><span class=nf>car</span> <span class=nv>x</span><span class=p>)</span> <span class=ss>&#39;ec%</span><span class=p>)</span> <span class=c1>;;逗号处理，即 ,expr</span>
</span></span><span class=line><span class=ln id=hl-27-17><a class=lnlinks href=#hl-27-17>17</a></span><span class=cl>     <span class=p>(</span><span class=nf>cadr</span> <span class=nv>x</span><span class=p>))</span> <span class=c1>;; (unquote expr)</span>
</span></span><span class=line><span class=ln id=hl-27-18><a class=lnlinks href=#hl-27-18>18</a></span><span class=cl>    <span class=p>((</span><span class=nf>eq</span> <span class=p>(</span><span class=nf>car</span> <span class=nv>x</span><span class=p>)</span> <span class=ss>&#39;ec%@</span><span class=p>)</span> <span class=c1>;;`的后面不应直接出现 ,@</span>
</span></span><span class=line><span class=ln id=hl-27-19><a class=lnlinks href=#hl-27-19>19</a></span><span class=cl>     <span class=p>(</span><span class=kt>error</span> <span class=s>&#34;,@~S after `&#34;</span> <span class=p>(</span><span class=nf>cadr</span> <span class=nv>x</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-27-20><a class=lnlinks href=#hl-27-20>20</a></span><span class=cl>    <span class=p>(</span><span class=no>t</span> <span class=c1>;; 处理 `(a1 a2 ... an) 的情况</span>
</span></span><span class=line><span class=ln id=hl-27-21><a class=lnlinks href=#hl-27-21>21</a></span><span class=cl>     <span class=p>(</span><span class=nb>do</span> <span class=c1>;;使用 ec-bracket 处理表中的每一项</span>
</span></span><span class=line><span class=ln id=hl-27-22><a class=lnlinks href=#hl-27-22>22</a></span><span class=cl>      <span class=p>((</span><span class=nv>p</span> <span class=nv>x</span> <span class=p>(</span><span class=nf>cdr</span> <span class=nv>p</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-27-23><a class=lnlinks href=#hl-27-23>23</a></span><span class=cl>       <span class=p>(</span><span class=nv>q</span> <span class=o>&#39;</span><span class=p>()</span> <span class=p>(</span><span class=nc>cons</span> <span class=p>(</span><span class=nv>ec-bracket</span> <span class=p>(</span><span class=nf>car</span> <span class=nv>p</span><span class=p>))</span> <span class=nv>q</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-27-24><a class=lnlinks href=#hl-27-24>24</a></span><span class=cl>      <span class=p>((</span><span class=kt>atom</span> <span class=nv>p</span><span class=p>)</span> <span class=c1>;;结束条件</span>
</span></span><span class=line><span class=ln id=hl-27-25><a class=lnlinks href=#hl-27-25>25</a></span><span class=cl>       <span class=p>(</span><span class=nc>cons</span> <span class=ss>&#39;append</span>
</span></span><span class=line><span class=ln id=hl-27-26><a class=lnlinks href=#hl-27-26>26</a></span><span class=cl>         <span class=p>(</span><span class=nf>nreconc</span> <span class=nv>q</span> <span class=p>(</span><span class=nc>list</span> <span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;quote</span> <span class=nv>p</span><span class=p>)))))</span>
</span></span><span class=line><span class=ln id=hl-27-27><a class=lnlinks href=#hl-27-27>27</a></span><span class=cl>       <span class=c1>;;中途检查</span>
</span></span><span class=line><span class=ln id=hl-27-28><a class=lnlinks href=#hl-27-28>28</a></span><span class=cl>       <span class=p>(</span><span class=nb>when</span> <span class=p>(</span><span class=nf>eq</span> <span class=p>(</span><span class=nf>car</span> <span class=nv>p</span><span class=p>)</span> <span class=ss>&#39;ec%</span><span class=p>)</span> <span class=c1>;; 遇到了落单的 `,&#39;</span>
</span></span><span class=line><span class=ln id=hl-27-29><a class=lnlinks href=#hl-27-29>29</a></span><span class=cl>     <span class=c1>;;它只能以 `(e1 e2 ... . ,e-last) 的形式出现</span>
</span></span><span class=line><span class=ln id=hl-27-30><a class=lnlinks href=#hl-27-30>30</a></span><span class=cl>     <span class=c1>;;一般情况下，待处理表的形式是 ((unquote ...) ...)，取其 car 得到的是表而不是符号</span>
</span></span><span class=line><span class=ln id=hl-27-31><a class=lnlinks href=#hl-27-31>31</a></span><span class=cl>     <span class=p>(</span><span class=nb>unless</span> <span class=p>(</span><span class=nc>null</span> <span class=p>(</span><span class=nf>cddr</span> <span class=nv>p</span><span class=p>))</span> <span class=p>(</span><span class=kt>error</span> <span class=s>&#34;Malformed ,~S&#34;</span> <span class=nv>p</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-27-32><a class=lnlinks href=#hl-27-32>32</a></span><span class=cl>     <span class=p>(</span><span class=nb>return</span> <span class=p>(</span><span class=nc>cons</span> <span class=ss>&#39;append</span> <span class=p>(</span><span class=nf>nreconc</span> <span class=nv>q</span> <span class=p>(</span><span class=nc>list</span> <span class=p>(</span><span class=nf>cadr</span> <span class=nv>p</span><span class=p>))))))</span>
</span></span><span class=line><span class=ln id=hl-27-33><a class=lnlinks href=#hl-27-33>33</a></span><span class=cl>       <span class=p>(</span><span class=nb>when</span> <span class=p>(</span><span class=nf>eq</span> <span class=p>(</span><span class=nf>car</span> <span class=nv>p</span><span class=p>)</span> <span class=ss>&#39;ec%@</span><span class=p>)</span> <span class=c1>;;遇到了落单的 ,@ 。它不可能单独出现</span>
</span></span><span class=line><span class=ln id=hl-27-34><a class=lnlinks href=#hl-27-34>34</a></span><span class=cl>     <span class=p>(</span><span class=kt>error</span> <span class=s>&#34;dotted ,@~S&#34;</span> <span class=nv>p</span><span class=p>))))))</span>
</span></span><span class=line><span class=ln id=hl-27-35><a class=lnlinks href=#hl-27-35>35</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-27-36><a class=lnlinks href=#hl-27-36>36</a></span><span class=cl><span class=p>(</span><span class=nb>defun</span> <span class=nv>ec-bracket</span> <span class=p>(</span><span class=nv>x</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-27-37><a class=lnlinks href=#hl-27-37>37</a></span><span class=cl>  <span class=p>(</span><span class=nb>cond</span>
</span></span><span class=line><span class=ln id=hl-27-38><a class=lnlinks href=#hl-27-38>38</a></span><span class=cl>    <span class=p>((</span><span class=kt>atom</span> <span class=nv>x</span><span class=p>)</span> <span class=c1>;; 给原子加上 quote</span>
</span></span><span class=line><span class=ln id=hl-27-39><a class=lnlinks href=#hl-27-39>39</a></span><span class=cl>     <span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;list</span> <span class=p>(</span><span class=nv>ec-bk-process</span> <span class=nv>x</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-27-40><a class=lnlinks href=#hl-27-40>40</a></span><span class=cl>    <span class=p>((</span><span class=nf>eq</span> <span class=p>(</span><span class=nf>car</span> <span class=nv>x</span><span class=p>)</span> <span class=ss>&#39;ec%</span><span class=p>)</span> <span class=c1>;; 对 (unquote expr) 的处理</span>
</span></span><span class=line><span class=ln id=hl-27-41><a class=lnlinks href=#hl-27-41>41</a></span><span class=cl>     <span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;list</span> <span class=p>(</span><span class=nf>cadr</span> <span class=nv>x</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-27-42><a class=lnlinks href=#hl-27-42>42</a></span><span class=cl>    <span class=p>((</span><span class=nf>eq</span> <span class=p>(</span><span class=nf>car</span> <span class=nv>x</span><span class=p>)</span> <span class=ss>&#39;ec%@</span><span class=p>)</span> <span class=c1>;; 对 (unquote-splicing expr) 的处理</span>
</span></span><span class=line><span class=ln id=hl-27-43><a class=lnlinks href=#hl-27-43>43</a></span><span class=cl>     <span class=p>(</span><span class=nf>cadr</span> <span class=nv>x</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-27-44><a class=lnlinks href=#hl-27-44>44</a></span><span class=cl>    <span class=p>(</span><span class=no>t</span> <span class=c1>;; 其他情况，也就是规则中的“进一步处理”</span>
</span></span><span class=line><span class=ln id=hl-27-45><a class=lnlinks href=#hl-27-45>45</a></span><span class=cl>     <span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;list</span> <span class=p>(</span><span class=nv>ec-bk-process</span> <span class=nv>x</span><span class=p>)))))</span>
</span></span></code></pre></div><p>我们可以用上面的例子来检验一下正确性，由于没有用 read-macro，所以写起来有点麻烦：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-28-1><a class=lnlinks href=#hl-28-1> 1</a></span><span class=cl><span class=p>(</span><span class=nv>ec$</span> <span class=p>(</span><span class=mi>1</span> <span class=p>(</span><span class=nv>ec%</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))))</span>
</span></span><span class=line><span class=ln id=hl-28-2><a class=lnlinks href=#hl-28-2> 2</a></span><span class=cl><span class=p>(</span><span class=mi>1</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-28-3><a class=lnlinks href=#hl-28-3> 3</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-28-4><a class=lnlinks href=#hl-28-4> 4</a></span><span class=cl><span class=p>(</span><span class=nv>ec$</span> <span class=p>((</span><span class=nv>ec%@</span> <span class=p>(</span><span class=nc>list</span> <span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))))</span>
</span></span><span class=line><span class=ln id=hl-28-5><a class=lnlinks href=#hl-28-5> 5</a></span><span class=cl><span class=p>(</span><span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-28-6><a class=lnlinks href=#hl-28-6> 6</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-28-7><a class=lnlinks href=#hl-28-7> 7</a></span><span class=cl><span class=p>(</span><span class=nv>ec$</span> <span class=p>(</span><span class=nv>ec$</span> <span class=p>((</span><span class=nv>ec%</span> <span class=p>(</span><span class=nv>ec%</span> <span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))))))</span>
</span></span><span class=line><span class=ln id=hl-28-8><a class=lnlinks href=#hl-28-8> 8</a></span><span class=cl><span class=p>(</span><span class=nv>APPEND</span> <span class=p>(</span><span class=nv>LIST</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span> <span class=ss>&#39;NIL</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-28-9><a class=lnlinks href=#hl-28-9> 9</a></span><span class=cl><span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-28-10><a class=lnlinks href=#hl-28-10>10</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-28-11><a class=lnlinks href=#hl-28-11>11</a></span><span class=cl><span class=p>(</span><span class=nv>ec$</span> <span class=p>(</span><span class=nv>ec$</span> <span class=p>((</span><span class=nv>ec%</span> <span class=p>(</span><span class=k>quote</span> <span class=p>(</span><span class=nv>ec%</span> <span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)))))))</span>
</span></span><span class=line><span class=ln id=hl-28-12><a class=lnlinks href=#hl-28-12>12</a></span><span class=cl><span class=p>(</span><span class=nv>APPEND</span> <span class=p>(</span><span class=nv>LIST</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span> <span class=ss>&#39;NIL</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-28-13><a class=lnlinks href=#hl-28-13>13</a></span><span class=cl><span class=p>((</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-28-14><a class=lnlinks href=#hl-28-14>14</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-28-15><a class=lnlinks href=#hl-28-15>15</a></span><span class=cl><span class=p>(</span><span class=nv>ec$</span> <span class=p>(</span><span class=nv>ec$</span> <span class=p>((</span><span class=nv>ec%@</span> <span class=p>(</span><span class=nv>ec%</span> <span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;list</span> <span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))))))</span>
</span></span><span class=line><span class=ln id=hl-28-16><a class=lnlinks href=#hl-28-16>16</a></span><span class=cl><span class=p>(</span><span class=nv>APPEND</span> <span class=p>(</span><span class=nv>LIST</span> <span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)</span> <span class=ss>&#39;NIL</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-28-17><a class=lnlinks href=#hl-28-17>17</a></span><span class=cl><span class=p>(</span><span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-28-18><a class=lnlinks href=#hl-28-18>18</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-28-19><a class=lnlinks href=#hl-28-19>19</a></span><span class=cl><span class=p>(</span><span class=nv>ec$</span> <span class=p>(</span><span class=nv>ec$</span> <span class=p>((</span><span class=nv>ec%@</span> <span class=p>(</span><span class=k>quote</span> <span class=p>(</span><span class=nv>ec%</span> <span class=p>(</span><span class=nc>list</span> <span class=ss>&#39;list</span> <span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)))))))</span>
</span></span><span class=line><span class=ln id=hl-28-20><a class=lnlinks href=#hl-28-20>20</a></span><span class=cl><span class=p>(</span><span class=nv>APPEND</span> <span class=o>&#39;</span><span class=p>(</span><span class=nv>LIST</span> <span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)</span> <span class=ss>&#39;NIL</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-28-21><a class=lnlinks href=#hl-28-21>21</a></span><span class=cl><span class=p>(</span><span class=nv>LIST</span> <span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-28-22><a class=lnlinks href=#hl-28-22>22</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-28-23><a class=lnlinks href=#hl-28-23>23</a></span><span class=cl><span class=p>(</span><span class=nv>ec$</span> <span class=p>(</span><span class=nv>ec$</span> <span class=p>((</span><span class=nv>ec%</span> <span class=p>(</span><span class=nv>ec%@</span> <span class=p>(</span><span class=nc>list</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)))))))</span>
</span></span><span class=line><span class=ln id=hl-28-24><a class=lnlinks href=#hl-28-24>24</a></span><span class=cl><span class=p>(</span><span class=nv>APPEND</span> <span class=p>(</span><span class=nv>LIST</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=p>(</span><span class=nf>+</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))</span> <span class=ss>&#39;NIL</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-28-25><a class=lnlinks href=#hl-28-25>25</a></span><span class=cl><span class=p>(</span><span class=mi>3</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-28-26><a class=lnlinks href=#hl-28-26>26</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-28-27><a class=lnlinks href=#hl-28-27>27</a></span><span class=cl><span class=p>(</span><span class=nv>ec$</span> <span class=p>(</span><span class=nv>ec$</span> <span class=p>((</span><span class=nv>ec%</span> <span class=p>(</span><span class=k>quote</span> <span class=p>(</span><span class=nv>ec%@</span> <span class=p>(</span><span class=nc>list</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))))))))</span>
</span></span><span class=line><span class=ln id=hl-28-28><a class=lnlinks href=#hl-28-28>28</a></span><span class=cl><span class=p>(</span><span class=nv>APPEND</span> <span class=p>(</span><span class=nv>LIST</span> <span class=o>&#39;</span><span class=p>(</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span> <span class=ss>&#39;NIL</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-28-29><a class=lnlinks href=#hl-28-29>29</a></span><span class=cl><span class=p>((</span><span class=nf>+</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-28-30><a class=lnlinks href=#hl-28-30>30</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-28-31><a class=lnlinks href=#hl-28-31>31</a></span><span class=cl><span class=p>(</span><span class=nv>ec$</span> <span class=p>(</span><span class=nv>ec$</span> <span class=p>((</span><span class=nv>ec%@</span> <span class=p>(</span><span class=nv>ec%@</span> <span class=p>(</span><span class=nc>list</span> <span class=o>&#39;</span><span class=p>(</span><span class=nc>list</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=o>&#39;</span><span class=p>(</span><span class=nc>list</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)))))))</span>
</span></span><span class=line><span class=ln id=hl-28-32><a class=lnlinks href=#hl-28-32>32</a></span><span class=cl><span class=p>(</span><span class=nv>APPEND</span> <span class=p>(</span><span class=nv>LIST</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=p>(</span><span class=nv>LIST</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)</span> <span class=ss>&#39;NIL</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-28-33><a class=lnlinks href=#hl-28-33>33</a></span><span class=cl><span class=p>(</span><span class=mi>1</span> <span class=mi>2</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-28-34><a class=lnlinks href=#hl-28-34>34</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-28-35><a class=lnlinks href=#hl-28-35>35</a></span><span class=cl><span class=p>(</span><span class=nv>ec$</span> <span class=p>(</span><span class=nv>ec$</span> <span class=p>((</span><span class=nv>ec%@</span> <span class=p>(</span><span class=nv>ec%@</span> <span class=p>(</span><span class=nc>list</span> <span class=o>&#39;</span><span class=p>(</span><span class=nc>list</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)))))))</span>
</span></span><span class=line><span class=ln id=hl-28-36><a class=lnlinks href=#hl-28-36>36</a></span><span class=cl><span class=p>(</span><span class=nv>APPEND</span> <span class=p>(</span><span class=nv>LIST</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>)</span> <span class=ss>&#39;NIL</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-28-37><a class=lnlinks href=#hl-28-37>37</a></span><span class=cl><span class=p>(</span><span class=mi>1</span> <span class=mi>2</span><span class=p>)</span>
</span></span></code></pre></div><p>本想着也简化一下 elisp 中的实现贴过来的，不过这一节的内容已经够多了，关于 elisp 我们留到下一节吧。</p><h2 id=elisp-中的-backquote-实现><a class=h-a href=#elisp-%e4%b8%ad%e7%9a%84-backquote-%e5%ae%9e%e7%8e%b0>elisp 中的 backquote 实现</a></h2><p>elisp 实现的就是类 Scheme 标准的 <code>backquote</code> ，它不能像 CL 一样处理形如 <code>,,@</code> ， <code>,@,@</code> 的嵌套 <code>unquote</code> 。考虑到 emacs lisp 主要继承于 maclisp，它的 <code>backquote</code> 与 CL 不一致挺正常的。但至于这种 <code>backquote</code> 是否来自 maclisp 我就没有精力进一步考古了。</p><blockquote><p>GNU Emacs Lisp is largely inspired by Maclisp, and a little by Common Lisp. If you know Common Lisp, you will notice many similarities. However, many features of Common Lisp have been omitted or simplified in order to reduce the memory requirements of GNU Emacs.</p><p><a class="link link--text" href=https://www.gnu.org/software/emacs/manual/html_node/elisp/Lisp-History.html rel=external>https://www.gnu.org/software/emacs/manual/html_node/elisp/Lisp-History.html</a></p></blockquote><p>在正式开始之前，我们来重新看看 Scheme 和 CL 的两种不同的 <code>backquote</code> 规则：</p><p>Scheme</p><ol><li>嵌套的 <code>quasiquote</code> 一次只展开一层</li><li>只替换和最外层同一层次的 <code>unquote</code></li><li>每出现一个 <code>`</code> 则层次加一，出现 <code>,</code> 或 <code>,@</code> 则层次减一</li></ol><p>CL</p><ol><li>若存在 <code>backquote</code> 嵌套，那么最里面的 <code>backquote</code> 先展开</li><li>最靠左的 <code>comma</code> （也就是一系列 <code>unquote</code> ）属于最里层的 <code>backquote</code></li></ol><p>可见，CL 强调的是内部先于外部展开，而 Scheme 强调的是同层次展开。这两者并不是等价的，Scheme 规则无法像 CL 一样处理类 <code>,,@</code> 嵌套。在 Racket 中我们可以看看 Scheme 的行为，它和 elisp 是一致的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-29-1><a class=lnlinks href=#hl-29-1>1</a></span><span class=cl><span class=nf>&gt;</span> <span class=o>``</span><span class=p>(</span><span class=o>,,@</span><span class=p>(</span><span class=nc>list</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-29-2><a class=lnlinks href=#hl-29-2>2</a></span><span class=cl><span class=o>&#39;`</span><span class=p>((</span><span class=nv>unquote</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-29-3><a class=lnlinks href=#hl-29-3>3</a></span><span class=cl><span class=nf>&gt;</span> <span class=o>`</span><span class=p>((</span><span class=nv>unquote</span> <span class=mi>1</span> <span class=mi>2</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-29-4><a class=lnlinks href=#hl-29-4>4</a></span><span class=cl><span class=c1>; stdin:2:2: unquote: expects exactly one expression</span>
</span></span><span class=line><span class=ln id=hl-29-5><a class=lnlinks href=#hl-29-5>5</a></span><span class=cl><span class=c1>;   at: (unquote 1 2)</span>
</span></span><span class=line><span class=ln id=hl-29-6><a class=lnlinks href=#hl-29-6>6</a></span><span class=cl><span class=c1>;   in: (quasiquote ((unquote 1 2)))</span>
</span></span><span class=line><span class=ln id=hl-29-7><a class=lnlinks href=#hl-29-7>7</a></span><span class=cl><span class=c1>; [,bt for context]</span>
</span></span></code></pre></div><p>扯了这么多废话，现在我们来具体分析一下 elisp 中的实现吧。</p><p>elisp 实现与 CL 不同，它在递归过程中会记录当前所在层数，当遇到 <code>,</code> 或 <code>,@</code> 时会根据当前层数判断表达式是否被求值。在处理过程中它会对表达式进行分类，它将常量用 0 标识，将非常量用 1 标识，将需要展平的表达式用 2 标识。emacs 实现会对常量表达式进行优化，不考虑优化的话可以简化它的代码。</p><p>老实说，emacs 中的实现挺难读的，我感觉我不太会讲，下面我贴一下化简后的代码，希望其中的注释对你有所帮助：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elisp data-lang=elisp><span class=line><span class=ln id=hl-30-1><a class=lnlinks href=#hl-30-1> 1</a></span><span class=cl><span class=p>(</span><span class=nb>defmacro</span> <span class=nv>ec$</span> <span class=p>(</span><span class=nv>s</span><span class=p>)</span> <span class=p>(</span><span class=nf>cdr</span> <span class=p>(</span><span class=nv>bk-process</span> <span class=nv>s</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-30-2><a class=lnlinks href=#hl-30-2> 2</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-30-3><a class=lnlinks href=#hl-30-3> 3</a></span><span class=cl><span class=p>(</span><span class=nb>defun</span> <span class=nv>bk-listify</span> <span class=p>(</span><span class=nf>list</span> <span class=nv>tail</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-30-4><a class=lnlinks href=#hl-30-4> 4</a></span><span class=cl>  <span class=p>(</span><span class=nb>let</span> <span class=p>((</span><span class=nv>heads</span> <span class=no>nil</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-30-5><a class=lnlinks href=#hl-30-5> 5</a></span><span class=cl>    <span class=p>(</span><span class=nv>list-tail</span> <span class=nf>list</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-30-6><a class=lnlinks href=#hl-30-6> 6</a></span><span class=cl>    <span class=p>(</span><span class=nv>item</span> <span class=no>nil</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-30-7><a class=lnlinks href=#hl-30-7> 7</a></span><span class=cl>    <span class=c1>;; while 循环给 list 中的带标识表达式去标识</span>
</span></span><span class=line><span class=ln id=hl-30-8><a class=lnlinks href=#hl-30-8> 8</a></span><span class=cl>    <span class=p>(</span><span class=nb>while</span> <span class=p>(</span><span class=nf>consp</span> <span class=nv>list-tail</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-30-9><a class=lnlinks href=#hl-30-9> 9</a></span><span class=cl>      <span class=p>(</span><span class=nb>setq</span> <span class=nv>item</span> <span class=p>(</span><span class=nf>car</span> <span class=nv>list-tail</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-30-10><a class=lnlinks href=#hl-30-10>10</a></span><span class=cl>      <span class=p>(</span><span class=nb>setq</span> <span class=nv>list-tail</span> <span class=p>(</span><span class=nf>cdr</span> <span class=nv>list-tail</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-30-11><a class=lnlinks href=#hl-30-11>11</a></span><span class=cl>      <span class=c1>;; 将 list 中的内容放入 heads 中</span>
</span></span><span class=line><span class=ln id=hl-30-12><a class=lnlinks href=#hl-30-12>12</a></span><span class=cl>      <span class=p>(</span><span class=nb>setq</span> <span class=nv>heads</span> <span class=p>(</span><span class=nf>cons</span> <span class=p>(</span><span class=nf>cdr</span> <span class=nv>item</span><span class=p>)</span> <span class=nv>heads</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-30-13><a class=lnlinks href=#hl-30-13>13</a></span><span class=cl>    <span class=p>(</span><span class=nf>cons</span> <span class=ss>&#39;cl-list*</span> <span class=p>(</span><span class=nf>append</span> <span class=nv>heads</span> <span class=p>(</span><span class=nf>list</span> <span class=p>(</span><span class=nf>cdr</span> <span class=nv>tail</span><span class=p>))))))</span>
</span></span><span class=line><span class=ln id=hl-30-14><a class=lnlinks href=#hl-30-14>14</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-30-15><a class=lnlinks href=#hl-30-15>15</a></span><span class=cl><span class=p>(</span><span class=nb>defun</span> <span class=nv>bk-delay-process</span> <span class=p>(</span><span class=nv>s</span> <span class=nv>level</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-30-16><a class=lnlinks href=#hl-30-16>16</a></span><span class=cl>  <span class=c1>;; 将头元素拿出来，对表剩余部分进行处理</span>
</span></span><span class=line><span class=ln id=hl-30-17><a class=lnlinks href=#hl-30-17>17</a></span><span class=cl>  <span class=p>(</span><span class=nb>let</span> <span class=p>((</span><span class=nf>exp</span> <span class=p>(</span><span class=nv>bk-listify</span> <span class=p>(</span><span class=nf>list</span> <span class=p>(</span><span class=nf>cons</span> <span class=mi>0</span> <span class=p>(</span><span class=nf>list</span> <span class=ss>&#39;quote</span> <span class=p>(</span><span class=nf>car</span> <span class=nv>s</span><span class=p>))))</span>
</span></span><span class=line><span class=ln id=hl-30-18><a class=lnlinks href=#hl-30-18>18</a></span><span class=cl>             <span class=p>(</span><span class=nv>bk-process</span> <span class=p>(</span><span class=nf>cdr</span> <span class=nv>s</span><span class=p>)</span> <span class=nv>level</span><span class=p>))))</span>
</span></span><span class=line><span class=ln id=hl-30-19><a class=lnlinks href=#hl-30-19>19</a></span><span class=cl>    <span class=p>(</span><span class=nf>cons</span> <span class=mi>0</span> <span class=nf>exp</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-30-20><a class=lnlinks href=#hl-30-20>20</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-30-21><a class=lnlinks href=#hl-30-21>21</a></span><span class=cl><span class=p>(</span><span class=nb>defun</span> <span class=nv>bk-process</span> <span class=p>(</span><span class=nv>s</span> <span class=kp>&amp;optional</span> <span class=nv>level</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-30-22><a class=lnlinks href=#hl-30-22>22</a></span><span class=cl>  <span class=p>(</span><span class=nb>unless</span> <span class=nv>level</span> <span class=p>(</span><span class=nb>setq</span> <span class=nv>level</span> <span class=mi>0</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-30-23><a class=lnlinks href=#hl-30-23>23</a></span><span class=cl>  <span class=p>(</span><span class=nb>cond</span>
</span></span><span class=line><span class=ln id=hl-30-24><a class=lnlinks href=#hl-30-24>24</a></span><span class=cl>   <span class=p>((</span><span class=nf>atom</span> <span class=nv>s</span><span class=p>)</span> <span class=c1>;;原子的处理</span>
</span></span><span class=line><span class=ln id=hl-30-25><a class=lnlinks href=#hl-30-25>25</a></span><span class=cl>    <span class=p>(</span><span class=nf>cons</span> <span class=mi>0</span> <span class=p>(</span><span class=nb>if</span> <span class=p>(</span><span class=nb>or</span> <span class=p>(</span><span class=nf>null</span> <span class=nv>s</span><span class=p>)</span> <span class=p>(</span><span class=nf>eq</span> <span class=no>t</span> <span class=nv>s</span><span class=p>))</span> <span class=nv>s</span> <span class=p>(</span><span class=nf>list</span> <span class=ss>&#39;quote</span> <span class=nv>s</span><span class=p>))))</span>
</span></span><span class=line><span class=ln id=hl-30-26><a class=lnlinks href=#hl-30-26>26</a></span><span class=cl>   <span class=p>((</span><span class=nf>eq</span> <span class=p>(</span><span class=nf>car</span> <span class=nv>s</span><span class=p>)</span> <span class=ss>&#39;ec%</span><span class=p>)</span> <span class=c1>;; unquote 的处理</span>
</span></span><span class=line><span class=ln id=hl-30-27><a class=lnlinks href=#hl-30-27>27</a></span><span class=cl>    <span class=p>(</span><span class=nb>if</span> <span class=p>(</span><span class=nf>&lt;=</span> <span class=nv>level</span> <span class=mi>0</span><span class=p>)</span> <span class=c1>;; 与最外层处于同一层级</span>
</span></span><span class=line><span class=ln id=hl-30-28><a class=lnlinks href=#hl-30-28>28</a></span><span class=cl>    <span class=p>(</span><span class=nb>cond</span>
</span></span><span class=line><span class=ln id=hl-30-29><a class=lnlinks href=#hl-30-29>29</a></span><span class=cl>     <span class=p>((</span><span class=nf>&gt;</span> <span class=p>(</span><span class=nf>length</span> <span class=nv>s</span><span class=p>)</span> <span class=mi>2</span><span class=p>)</span> <span class=c1>;; (unquote expr) 长度为 2，unquote 只能接受一个参数</span>
</span></span><span class=line><span class=ln id=hl-30-30><a class=lnlinks href=#hl-30-30>30</a></span><span class=cl>      <span class=p>(</span><span class=ne>error</span> <span class=s>&#34;Multiple args to , are not supported: %S&#34;</span> <span class=nv>s</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-30-31><a class=lnlinks href=#hl-30-31>31</a></span><span class=cl>     <span class=p>(</span><span class=no>t</span> <span class=p>(</span><span class=nf>cons</span> <span class=mi>1</span> <span class=p>(</span><span class=nf>nth</span> <span class=mi>1</span> <span class=nv>s</span><span class=p>))))</span>
</span></span><span class=line><span class=ln id=hl-30-32><a class=lnlinks href=#hl-30-32>32</a></span><span class=cl>      <span class=p>(</span><span class=nv>bk-delay-process</span> <span class=nv>s</span> <span class=p>(</span><span class=nf>1-</span> <span class=nv>level</span><span class=p>))))</span>
</span></span><span class=line><span class=ln id=hl-30-33><a class=lnlinks href=#hl-30-33>33</a></span><span class=cl>   <span class=p>((</span><span class=nf>eq</span> <span class=p>(</span><span class=nf>car</span> <span class=nv>s</span><span class=p>)</span> <span class=ss>&#39;ec%@</span><span class=p>)</span> <span class=c1>;; unquote-splicing 的处理</span>
</span></span><span class=line><span class=ln id=hl-30-34><a class=lnlinks href=#hl-30-34>34</a></span><span class=cl>    <span class=p>(</span><span class=nb>if</span> <span class=p>(</span><span class=nf>&lt;=</span> <span class=nv>level</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-30-35><a class=lnlinks href=#hl-30-35>35</a></span><span class=cl>    <span class=p>(</span><span class=nb>if</span> <span class=p>(</span><span class=nf>&gt;</span> <span class=p>(</span><span class=nf>length</span> <span class=nv>s</span><span class=p>)</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-30-36><a class=lnlinks href=#hl-30-36>36</a></span><span class=cl>        <span class=p>(</span><span class=ne>error</span> <span class=s>&#34;Multiple args to ,@ are not supported: %S&#34;</span> <span class=nv>s</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-30-37><a class=lnlinks href=#hl-30-37>37</a></span><span class=cl>      <span class=p>(</span><span class=nf>cons</span> <span class=mi>2</span> <span class=p>(</span><span class=nf>nth</span> <span class=mi>1</span> <span class=nv>s</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-30-38><a class=lnlinks href=#hl-30-38>38</a></span><span class=cl>      <span class=p>(</span><span class=nv>bk-delay-process</span> <span class=nv>s</span> <span class=p>(</span><span class=nf>1-</span> <span class=nv>level</span><span class=p>))))</span>
</span></span><span class=line><span class=ln id=hl-30-39><a class=lnlinks href=#hl-30-39>39</a></span><span class=cl>   <span class=p>((</span><span class=nf>eq</span> <span class=p>(</span><span class=nf>car</span> <span class=nv>s</span><span class=p>)</span> <span class=ss>&#39;ec$</span><span class=p>)</span> <span class=c1>;; 多了一层 backquote</span>
</span></span><span class=line><span class=ln id=hl-30-40><a class=lnlinks href=#hl-30-40>40</a></span><span class=cl>    <span class=p>(</span><span class=nv>bk-delay-process</span> <span class=nv>s</span> <span class=p>(</span><span class=nf>1+</span> <span class=nv>level</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-30-41><a class=lnlinks href=#hl-30-41>41</a></span><span class=cl>   <span class=p>(</span><span class=no>t</span> <span class=c1>;;剩余处理 `(a1 a2 ... an)</span>
</span></span><span class=line><span class=ln id=hl-30-42><a class=lnlinks href=#hl-30-42>42</a></span><span class=cl>    <span class=p>(</span><span class=nb>let</span> <span class=p>((</span><span class=nv>rest</span> <span class=nv>s</span><span class=p>)</span> <span class=c1>;; 表中剩下的元素</span>
</span></span><span class=line><span class=ln id=hl-30-43><a class=lnlinks href=#hl-30-43>43</a></span><span class=cl>      <span class=nv>item</span> <span class=c1>;;每次迭代的元素</span>
</span></span><span class=line><span class=ln id=hl-30-44><a class=lnlinks href=#hl-30-44>44</a></span><span class=cl>      <span class=nv>firstlist</span> <span class=c1>;;存储在遇到 `,@&#39; 前的表达式</span>
</span></span><span class=line><span class=ln id=hl-30-45><a class=lnlinks href=#hl-30-45>45</a></span><span class=cl>      <span class=nf>list</span> <span class=c1>;; 暂存处理结果</span>
</span></span><span class=line><span class=ln id=hl-30-46><a class=lnlinks href=#hl-30-46>46</a></span><span class=cl>      <span class=nv>lists</span> <span class=c1>;; 存储结果</span>
</span></span><span class=line><span class=ln id=hl-30-47><a class=lnlinks href=#hl-30-47>47</a></span><span class=cl>      <span class=nv>expression</span> <span class=c1>;;存储最终结果表达式</span>
</span></span><span class=line><span class=ln id=hl-30-48><a class=lnlinks href=#hl-30-48>48</a></span><span class=cl>      <span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-30-49><a class=lnlinks href=#hl-30-49>49</a></span><span class=cl>      <span class=c1>;;在循环结束后， firstlist 中存储前部分非 `,@&#39; 表达式， lists 中存储展平表达式，list 中存储后部分非 `,@&#39; 表达式</span>
</span></span><span class=line><span class=ln id=hl-30-50><a class=lnlinks href=#hl-30-50>50</a></span><span class=cl>      <span class=p>(</span><span class=nb>while</span> <span class=p>(</span><span class=nb>and</span> <span class=p>(</span><span class=nf>consp</span> <span class=nv>rest</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-30-51><a class=lnlinks href=#hl-30-51>51</a></span><span class=cl>          <span class=p>(</span><span class=nv>not</span> <span class=p>(</span><span class=nb>or</span> <span class=p>(</span><span class=nf>eq</span> <span class=p>(</span><span class=nf>car</span> <span class=nv>rest</span><span class=p>)</span> <span class=ss>&#39;ec%</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-30-52><a class=lnlinks href=#hl-30-52>52</a></span><span class=cl>               <span class=p>(</span><span class=nf>eq</span> <span class=p>(</span><span class=nf>car</span> <span class=nv>rest</span><span class=p>)</span> <span class=ss>&#39;ec%@</span><span class=p>))))</span>
</span></span><span class=line><span class=ln id=hl-30-53><a class=lnlinks href=#hl-30-53>53</a></span><span class=cl>    <span class=p>(</span><span class=nb>setq</span> <span class=nv>item</span> <span class=p>(</span><span class=nv>bk-process</span> <span class=p>(</span><span class=nf>car</span> <span class=nv>rest</span><span class=p>)</span> <span class=nv>level</span><span class=p>))</span> <span class=c1>;; 获取当前元素</span>
</span></span><span class=line><span class=ln id=hl-30-54><a class=lnlinks href=#hl-30-54>54</a></span><span class=cl>    <span class=p>(</span><span class=nb>cond</span>
</span></span><span class=line><span class=ln id=hl-30-55><a class=lnlinks href=#hl-30-55>55</a></span><span class=cl>     <span class=p>((</span><span class=nf>=</span> <span class=p>(</span><span class=nf>car</span> <span class=nv>item</span><span class=p>)</span> <span class=mi>2</span><span class=p>)</span> <span class=c1>;; car 为 2 说明需要展平</span>
</span></span><span class=line><span class=ln id=hl-30-56><a class=lnlinks href=#hl-30-56>56</a></span><span class=cl>      <span class=p>(</span><span class=nb>if</span> <span class=p>(</span><span class=nf>null</span> <span class=nv>lists</span><span class=p>)</span> <span class=c1>;; 首次遇到 `,@&#39; 表达式</span>
</span></span><span class=line><span class=ln id=hl-30-57><a class=lnlinks href=#hl-30-57>57</a></span><span class=cl>          <span class=p>(</span><span class=nb>setq</span> <span class=nv>firstlist</span> <span class=nf>list</span> <span class=c1>;; 将一些 `,&#39; 表达式放入 firstlist 中</span>
</span></span><span class=line><span class=ln id=hl-30-58><a class=lnlinks href=#hl-30-58>58</a></span><span class=cl>            <span class=nf>list</span> <span class=no>nil</span><span class=p>))</span> <span class=c1>;; 清空 list</span>
</span></span><span class=line><span class=ln id=hl-30-59><a class=lnlinks href=#hl-30-59>59</a></span><span class=cl>      <span class=p>(</span><span class=nb>if</span> <span class=nf>list</span> <span class=c1>;; 若 list 非空，将其中的项处理后放入 lists 中</span>
</span></span><span class=line><span class=ln id=hl-30-60><a class=lnlinks href=#hl-30-60>60</a></span><span class=cl>          <span class=c1>;;这一步挺妙的, list 是多个项组成的表，到时候和 `,@&#39; 项一起展平</span>
</span></span><span class=line><span class=ln id=hl-30-61><a class=lnlinks href=#hl-30-61>61</a></span><span class=cl>          <span class=p>(</span><span class=nb>push</span> <span class=p>(</span><span class=nv>bk-listify</span> <span class=nf>list</span> <span class=o>&#39;</span><span class=p>(</span><span class=mi>0</span> <span class=o>.</span> <span class=no>nil</span><span class=p>))</span> <span class=nv>lists</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-30-62><a class=lnlinks href=#hl-30-62>62</a></span><span class=cl>      <span class=p>(</span><span class=nb>push</span> <span class=p>(</span><span class=nf>cdr</span> <span class=nv>item</span><span class=p>)</span> <span class=nv>lists</span><span class=p>)</span> <span class=c1>;; 将 splicing 表达式的序号去掉后，放入 lists 中</span>
</span></span><span class=line><span class=ln id=hl-30-63><a class=lnlinks href=#hl-30-63>63</a></span><span class=cl>      <span class=p>(</span><span class=nb>setq</span> <span class=nf>list</span> <span class=no>nil</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-30-64><a class=lnlinks href=#hl-30-64>64</a></span><span class=cl>     <span class=p>(</span><span class=no>t</span> <span class=c1>;; 非展平表达式，无需处理</span>
</span></span><span class=line><span class=ln id=hl-30-65><a class=lnlinks href=#hl-30-65>65</a></span><span class=cl>      <span class=p>(</span><span class=nb>setq</span> <span class=nf>list</span> <span class=p>(</span><span class=nf>cons</span> <span class=nv>item</span> <span class=nf>list</span><span class=p>))))</span> <span class=c1>;;结果存储到 list 中</span>
</span></span><span class=line><span class=ln id=hl-30-66><a class=lnlinks href=#hl-30-66>66</a></span><span class=cl>    <span class=p>(</span><span class=nb>setq</span> <span class=nv>rest</span> <span class=p>(</span><span class=nf>cdr</span> <span class=nv>rest</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-30-67><a class=lnlinks href=#hl-30-67>67</a></span><span class=cl>      <span class=c1>;;将 list 中的剩余项放入 lists 中去</span>
</span></span><span class=line><span class=ln id=hl-30-68><a class=lnlinks href=#hl-30-68>68</a></span><span class=cl>      <span class=p>(</span><span class=nb>if</span> <span class=p>(</span><span class=nb>or</span> <span class=nv>rest</span> <span class=nf>list</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-30-69><a class=lnlinks href=#hl-30-69>69</a></span><span class=cl>      <span class=p>(</span><span class=nb>push</span> <span class=p>(</span><span class=nv>bk-listify</span> <span class=nf>list</span> <span class=p>(</span><span class=nv>bk-process</span> <span class=nv>rest</span> <span class=nv>level</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-30-70><a class=lnlinks href=#hl-30-70>70</a></span><span class=cl>        <span class=nv>lists</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-30-71><a class=lnlinks href=#hl-30-71>71</a></span><span class=cl>      <span class=c1>;; 若只有一项则取首元素</span>
</span></span><span class=line><span class=ln id=hl-30-72><a class=lnlinks href=#hl-30-72>72</a></span><span class=cl>      <span class=p>(</span><span class=nb>setq</span> <span class=nv>expression</span>
</span></span><span class=line><span class=ln id=hl-30-73><a class=lnlinks href=#hl-30-73>73</a></span><span class=cl>        <span class=p>(</span><span class=nb>if</span> <span class=p>(</span><span class=nb>or</span> <span class=p>(</span><span class=nf>cdr</span> <span class=nv>lists</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-30-74><a class=lnlinks href=#hl-30-74>74</a></span><span class=cl>            <span class=p>(</span><span class=nf>eq</span> <span class=p>(</span><span class=nf>car-safe</span> <span class=p>(</span><span class=nf>car</span> <span class=nv>lists</span><span class=p>))</span> <span class=ss>&#39;ec%@</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-30-75><a class=lnlinks href=#hl-30-75>75</a></span><span class=cl>        <span class=p>(</span><span class=nf>cons</span> <span class=ss>&#39;append</span> <span class=p>(</span><span class=nf>nreverse</span> <span class=nv>lists</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-30-76><a class=lnlinks href=#hl-30-76>76</a></span><span class=cl>          <span class=p>(</span><span class=nf>car</span> <span class=nv>lists</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-30-77><a class=lnlinks href=#hl-30-77>77</a></span><span class=cl>      <span class=c1>;;将 firstlist 中的项处理后放入 expression 中</span>
</span></span><span class=line><span class=ln id=hl-30-78><a class=lnlinks href=#hl-30-78>78</a></span><span class=cl>      <span class=p>(</span><span class=nb>if</span> <span class=nv>firstlist</span>
</span></span><span class=line><span class=ln id=hl-30-79><a class=lnlinks href=#hl-30-79>79</a></span><span class=cl>      <span class=p>(</span><span class=nb>setq</span> <span class=nv>expression</span> <span class=p>(</span><span class=nv>bk-listify</span> <span class=nv>firstlist</span> <span class=p>(</span><span class=nf>cons</span> <span class=mi>0</span> <span class=nv>expression</span><span class=p>))))</span>
</span></span><span class=line><span class=ln id=hl-30-80><a class=lnlinks href=#hl-30-80>80</a></span><span class=cl>      <span class=p>(</span><span class=nf>cons</span> <span class=mi>0</span> <span class=nv>expression</span><span class=p>)))))</span>
</span></span></code></pre></div><p>总之，它没有像 CL 一样从里到外展开，这也就是展开行为与 CL 不一致的原因。</p><p>这一节主要就是点代码，到了这里本文也就基本结束了。</p><h2 id=尾声><a class=h-a href=#%e5%b0%be%e5%a3%b0>尾声</a></h2><p>我们以 <code>once-only</code> 这个有名的宏来作为本文的终结吧。看完了上面的内容，相信你一定能看懂这段代码了 &#x1f601;</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-31-1><a class=lnlinks href=#hl-31-1>1</a></span><span class=cl><span class=c1>;;CL</span>
</span></span><span class=line><span class=ln id=hl-31-2><a class=lnlinks href=#hl-31-2>2</a></span><span class=cl><span class=p>(</span><span class=nb>defmacro</span> <span class=nv>once-only</span> <span class=p>(</span><span class=nv>names</span> <span class=k>&amp;rest</span> <span class=nv>body</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-31-3><a class=lnlinks href=#hl-31-3>3</a></span><span class=cl>  <span class=p>(</span><span class=k>let</span> <span class=p>((</span><span class=nv>gensyms</span> <span class=p>(</span><span class=nb>loop</span> <span class=nv>repeat</span> <span class=p>(</span><span class=nf>length</span> <span class=nv>names</span><span class=p>)</span> <span class=nv>collect</span> <span class=p>(</span><span class=nf>gensym</span><span class=p>))))</span>
</span></span><span class=line><span class=ln id=hl-31-4><a class=lnlinks href=#hl-31-4>4</a></span><span class=cl>    <span class=o>`</span><span class=p>(</span><span class=k>let</span> <span class=p>(</span><span class=o>,@</span><span class=p>(</span><span class=nb>loop</span> <span class=nv>for</span> <span class=nv>g</span> <span class=nv>in</span> <span class=nv>gensyms</span> <span class=nv>collect</span> <span class=o>`</span><span class=p>(</span><span class=o>,</span><span class=nv>g</span> <span class=p>(</span><span class=nf>gensym</span><span class=p>))))</span>
</span></span><span class=line><span class=ln id=hl-31-5><a class=lnlinks href=#hl-31-5>5</a></span><span class=cl>       <span class=o>`</span><span class=p>(</span><span class=k>let</span> <span class=p>(</span><span class=o>,,@</span><span class=p>(</span><span class=nb>loop</span> <span class=nv>for</span> <span class=nv>g</span> <span class=nv>in</span> <span class=nv>gensyms</span> <span class=nv>for</span> <span class=nv>n</span> <span class=nv>in</span> <span class=nv>names</span>
</span></span><span class=line><span class=ln id=hl-31-6><a class=lnlinks href=#hl-31-6>6</a></span><span class=cl>              <span class=nv>collect</span> <span class=o>``</span><span class=p>(</span><span class=o>,,</span><span class=nv>g</span> <span class=o>,,</span><span class=nv>n</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-31-7><a class=lnlinks href=#hl-31-7>7</a></span><span class=cl>      <span class=o>,</span><span class=p>(</span><span class=k>let</span> <span class=p>(</span><span class=o>,@</span><span class=p>(</span><span class=nb>loop</span> <span class=nv>for</span> <span class=nv>n</span> <span class=nv>in</span> <span class=nv>names</span> <span class=nv>for</span> <span class=nv>g</span> <span class=nv>in</span> <span class=nv>gensyms</span>
</span></span><span class=line><span class=ln id=hl-31-8><a class=lnlinks href=#hl-31-8>8</a></span><span class=cl>                <span class=nv>collect</span> <span class=o>`</span><span class=p>(</span><span class=o>,</span><span class=nv>n</span> <span class=o>,</span><span class=nv>g</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-31-9><a class=lnlinks href=#hl-31-9>9</a></span><span class=cl>         <span class=o>,@</span><span class=nv>body</span><span class=p>)))))</span>
</span></span></code></pre></div><p>下面是 elisp 实现：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-elisp data-lang=elisp><span class=line><span class=ln id=hl-32-1><a class=lnlinks href=#hl-32-1> 1</a></span><span class=cl><span class=c1>;;elisp</span>
</span></span><span class=line><span class=ln id=hl-32-2><a class=lnlinks href=#hl-32-2> 2</a></span><span class=cl><span class=p>(</span><span class=nb>defmacro</span> <span class=nv>with-gensyms</span> <span class=p>(</span><span class=nv>symbols</span> <span class=kp>&amp;rest</span> <span class=nv>body</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-32-3><a class=lnlinks href=#hl-32-3> 3</a></span><span class=cl>  <span class=s>&#34;Execute BODY in a context where the variables in SYMBOLS are bound to
</span></span></span><span class=line><span class=ln id=hl-32-4><a class=lnlinks href=#hl-32-4> 4</a></span><span class=cl><span class=s>fresh gensyms.&#34;</span>
</span></span><span class=line><span class=ln id=hl-32-5><a class=lnlinks href=#hl-32-5> 5</a></span><span class=cl>  <span class=p>(</span><span class=ne>cl-assert</span> <span class=p>(</span><span class=nv>cl-every</span> <span class=nf>#&#39;symbolp</span> <span class=nv>symbols</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-32-6><a class=lnlinks href=#hl-32-6> 6</a></span><span class=cl>  <span class=o>`</span><span class=p>(</span><span class=nb>let</span> <span class=o>,</span><span class=p>(</span><span class=nv>cl-mapcar</span> <span class=nf>#&#39;list</span> <span class=nv>symbols</span> <span class=o>&#39;#1=</span><span class=p>((</span><span class=nv>gensym</span><span class=p>)</span> <span class=o>.</span> <span class=o>#1#</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-32-7><a class=lnlinks href=#hl-32-7> 7</a></span><span class=cl>     <span class=o>,@</span><span class=nv>body</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-32-8><a class=lnlinks href=#hl-32-8> 8</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-32-9><a class=lnlinks href=#hl-32-9> 9</a></span><span class=cl><span class=p>(</span><span class=nb>defmacro</span> <span class=nv>once-only</span> <span class=p>(</span><span class=nv>symbols</span> <span class=kp>&amp;rest</span> <span class=nv>body</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-32-10><a class=lnlinks href=#hl-32-10>10</a></span><span class=cl>  <span class=s>&#34;Execute BODY in a context where the values bound to the variables in
</span></span></span><span class=line><span class=ln id=hl-32-11><a class=lnlinks href=#hl-32-11>11</a></span><span class=cl><span class=s>SYMBOLS are bound to fresh gensyms, and the variables in SYMBOLS are bound
</span></span></span><span class=line><span class=ln id=hl-32-12><a class=lnlinks href=#hl-32-12>12</a></span><span class=cl><span class=s>to the corresponding gensym.&#34;</span>
</span></span><span class=line><span class=ln id=hl-32-13><a class=lnlinks href=#hl-32-13>13</a></span><span class=cl>  <span class=p>(</span><span class=nb>declare</span> <span class=p>(</span><span class=nv>indent</span> <span class=mi>1</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-32-14><a class=lnlinks href=#hl-32-14>14</a></span><span class=cl>  <span class=p>(</span><span class=ne>cl-assert</span> <span class=p>(</span><span class=nv>cl-every</span> <span class=nf>#&#39;symbolp</span> <span class=nv>symbols</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-32-15><a class=lnlinks href=#hl-32-15>15</a></span><span class=cl>  <span class=p>(</span><span class=nb>let</span> <span class=p>((</span><span class=nv>gensyms</span> <span class=p>(</span><span class=nv>cl-mapcar</span> <span class=p>(</span><span class=nb>lambda</span> <span class=p>(</span><span class=nv>x</span><span class=p>)</span> <span class=p>(</span><span class=nv>gensym</span><span class=p>))</span> <span class=nv>symbols</span><span class=p>)))</span>
</span></span><span class=line><span class=ln id=hl-32-16><a class=lnlinks href=#hl-32-16>16</a></span><span class=cl>    <span class=o>`</span><span class=p>(</span><span class=nv>with-gensyms</span> <span class=o>,</span><span class=nv>gensyms</span>
</span></span><span class=line><span class=ln id=hl-32-17><a class=lnlinks href=#hl-32-17>17</a></span><span class=cl>           <span class=p>(</span><span class=nf>list</span> <span class=ss>&#39;let</span> <span class=p>(</span><span class=nv>cl-mapcar</span> <span class=nf>#&#39;list</span> <span class=p>(</span><span class=nf>list</span> <span class=o>,@</span><span class=nv>gensyms</span><span class=p>)</span> <span class=p>(</span><span class=nf>list</span> <span class=o>,@</span><span class=nv>symbols</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-32-18><a class=lnlinks href=#hl-32-18>18</a></span><span class=cl>             <span class=o>,</span><span class=p>(</span><span class=nv>cl-list*</span> <span class=ss>&#39;let</span> <span class=p>(</span><span class=nv>cl-mapcar</span> <span class=nf>#&#39;list</span> <span class=nv>symbols</span> <span class=nv>gensyms</span><span class=p>)</span>
</span></span><span class=line><span class=ln id=hl-32-19><a class=lnlinks href=#hl-32-19>19</a></span><span class=cl>                    <span class=nv>body</span><span class=p>)))))</span>
</span></span></code></pre></div><p>最后需要提醒一下的是，不同的 CL 实现中对于 backquote 的处理不一定相同，有些 CL 实现可能与标准并不完全一致：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-lisp data-lang=lisp><span class=line><span class=ln id=hl-33-1><a class=lnlinks href=#hl-33-1>1</a></span><span class=cl><span class=c1>;;ECL</span>
</span></span><span class=line><span class=ln id=hl-33-2><a class=lnlinks href=#hl-33-2>2</a></span><span class=cl><span class=nv>CL-USER&gt;</span> <span class=o>``</span><span class=p>(</span><span class=o>,@,@</span><span class=p>(</span><span class=nc>list</span> <span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-33-3><a class=lnlinks href=#hl-33-3>3</a></span><span class=cl>                                        <span class=c1>; Evaluation aborted on #&lt;a SIMPLE-ERROR 0x3d28500&gt;.</span>
</span></span><span class=line><span class=ln id=hl-33-4><a class=lnlinks href=#hl-33-4>4</a></span><span class=cl><span class=o>,@</span> <span class=nb>or</span> <span class=o>,.</span> <span class=nv>has</span> <span class=nv>appeared</span> <span class=nv>in</span> <span class=nv>an</span> <span class=nv>illegal</span> <span class=nv>position.</span>
</span></span><span class=line><span class=ln id=hl-33-5><a class=lnlinks href=#hl-33-5>5</a></span><span class=cl>   <span class=nv>[Condition</span> <span class=nv>of</span> <span class=k>type</span> <span class=nv>SIMPLE-ERROR]</span>
</span></span><span class=line><span class=ln id=hl-33-6><a class=lnlinks href=#hl-33-6>6</a></span><span class=cl>
</span></span><span class=line><span class=ln id=hl-33-7><a class=lnlinks href=#hl-33-7>7</a></span><span class=cl><span class=c1>;;SBCL</span>
</span></span><span class=line><span class=ln id=hl-33-8><a class=lnlinks href=#hl-33-8>8</a></span><span class=cl><span class=nv>\*</span> <span class=o>``</span><span class=p>(</span><span class=o>,@,@</span><span class=p>(</span><span class=nc>list</span> <span class=mi>1</span> <span class=mi>2</span> <span class=mi>3</span><span class=p>))</span>
</span></span><span class=line><span class=ln id=hl-33-9><a class=lnlinks href=#hl-33-9>9</a></span><span class=cl><span class=nv>=&gt;</span> <span class=o>`</span><span class=p>(</span><span class=o>,@</span><span class=mi>1</span> <span class=o>,@</span><span class=mi>2</span> <span class=o>,@</span><span class=mi>3</span><span class=p>)</span>
</span></span></code></pre></div><hr><p class=box-info>本文由 <a class="link link--text" href=/authors/include-yy/>include-yy</a> 原创，并以 CC-BY-SA 4.0 协议授权 <a class="link link--text" href=/authors/clsty/>clsty</a> 使用。&#8200;<br class=br-cond>版权归属原作者（<a class="link link--text" href=https://egh0bww1.com/posts/2022-06-26-19-understand-backquote rel=external>原文链接</a>）。</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p><a class="link link--text" href=https://emacs-china.org/t/backquote/20060 rel=external>https://emacs-china.org/t/backquote/20060</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p><a class="link link--text" href=https://www.cs.cmu.edu/Groups/AI/html/cltl/clm/node367.html rel=external>https://www.cs.cmu.edu/Groups/AI/html/cltl/clm/node367.html</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class=margin-full><section class=section><h2>相关阅读</h2><nav class="card-nav card-nav--2"><ul class=card-nav__list><li class="card card--1 card--1--row"><a href=/p/25dbc0cc9/btrfs-simple-intro/ class=card__hover><div class="card__flex card__flex--half"><figure class="fig fig--w-tiny card__fig card__fig--half"><span class="img__frame img__frame--box-shadow img__frame--pad-none" style="display:flex;justify-content:center;align-items:center;background-image:linear-gradient(to right,#3a311d,#a89c62)"><span class=img__c style=position:relative;width:100%;height:0;padding-bottom:86.2069%><img alt="Featured image" class="img--ls img--ph lazyload" data-optimumx=auto data-sizes=auto data-srcset="/p/25dbc0cc9/btrfs-simple-intro/pic.featured/mr-cup-fabien-barral-o6GEPQXnqMY-unsplash-3304x2848--128x.webp 128w, /p/25dbc0cc9/btrfs-simple-intro/pic.featured/mr-cup-fabien-barral-o6GEPQXnqMY-unsplash-3304x2848--143x.webp 143w, /p/25dbc0cc9/btrfs-simple-intro/pic.featured/mr-cup-fabien-barral-o6GEPQXnqMY-unsplash-3304x2848--159x.webp 159w, /p/25dbc0cc9/btrfs-simple-intro/pic.featured/mr-cup-fabien-barral-o6GEPQXnqMY-unsplash-3304x2848--165x.webp 165w, /p/25dbc0cc9/btrfs-simple-intro/pic.featured/mr-cup-fabien-barral-o6GEPQXnqMY-unsplash-3304x2848--178x.webp 178w, /p/25dbc0cc9/btrfs-simple-intro/pic.featured/mr-cup-fabien-barral-o6GEPQXnqMY-unsplash-3304x2848--199x.webp 199w, /p/25dbc0cc9/btrfs-simple-intro/pic.featured/mr-cup-fabien-barral-o6GEPQXnqMY-unsplash-3304x2848--222x.webp 222w, /p/25dbc0cc9/btrfs-simple-intro/pic.featured/mr-cup-fabien-barral-o6GEPQXnqMY-unsplash-3304x2848--248x.webp 248w, /p/25dbc0cc9/btrfs-simple-intro/pic.featured/mr-cup-fabien-barral-o6GEPQXnqMY-unsplash-3304x2848--276x.webp 276w, /p/25dbc0cc9/btrfs-simple-intro/pic.featured/mr-cup-fabien-barral-o6GEPQXnqMY-unsplash-3304x2848--308x.webp 308w, /p/25dbc0cc9/btrfs-simple-intro/pic.featured/mr-cup-fabien-barral-o6GEPQXnqMY-unsplash-3304x2848--344x.webp 344w, /p/25dbc0cc9/btrfs-simple-intro/pic.featured/mr-cup-fabien-barral-o6GEPQXnqMY-unsplash-3304x2848--384x.webp 384w, /p/25dbc0cc9/btrfs-simple-intro/pic.featured/mr-cup-fabien-barral-o6GEPQXnqMY-unsplash-3304x2848--429x.webp 429w" height=142 src=/p/25dbc0cc9/btrfs-simple-intro/pic.featured/mr-cup-fabien-barral-o6GEPQXnqMY-unsplash-3304x2848--165x.webp srcset=data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7 width=165></span></span></figure><div class=card__content><div><div class=card__header><div class="meta meta--card meta--card--half"><ul class="ul--row meta__list"><li class="meta__item meta__list"><span class=meta__text>散文屋</span></li></ul></div><h3 class="card__title card__title--half">BTRFS 实践式快速入门</h3></div></div></div></div></a></li></ul></nav></section></div></article><footer class="page-footer margin-full"><div class="meta meta--foot"><nav><ul class=meta__list><li class="taxo-shape taxo-shape--category"><ul class=ul--row><li class=meta__hanging><a class="link link--nav" href=/categories/ title="All Categories"><span class='icon icon--material icon--tiny'><svg viewBox="0 0 20 20"><path d="m5.042 9.479 4.979-8.146L15 9.479zm9.666 9.167q-1.646.0-2.791-1.156-1.146-1.157-1.146-2.782.0-1.646 1.146-2.791 1.145-1.146 2.791-1.146 1.625.0 2.782 1.146 1.156 1.145 1.156 2.791.0 1.625-1.156 2.782-1.157 1.156-2.782 1.156zm-12.583-.417v-7.062h7.063v7.062z"/></svg></span></a></li><li class="meta__item meta__item--taxo"><a class="meta__text link link--nav" href=/categories/knowledge/>知识向</a></li></ul></li><li class="taxo-shape taxo-shape--tag"><ul class=ul--row><li class=meta__hanging><a class="link link--nav" href=/tags/ title="All Tags"><span class='icon icon--material icon--tiny'><svg viewBox="0 0 20 20"><path d="M3.188 10.542v5.875L.917 15.5zm4.062 7.75h-2.5V11.5zm1.958.75L4.146 5.333 14 1.75l5.042 13.729zm.021-10.5q.396.0.677-.282.282-.281.282-.677.0-.375-.282-.656-.281-.281-.677-.281-.375.0-.656.281t-.281.656q0 .396.281.677.281.282.656.282z"/></svg></span></a></li><li class="meta__item meta__item--taxo"><a class="meta__text link link--nav" href=/tags/lisp/>Lisp
</a>&zwj;<span class=meta__separator>•</span></li><li class="meta__item meta__item--taxo"><a class="meta__text link link--nav" href=/tags/emacs/>Emacs</a></li></ul></li></ul><ul class="ul--row meta__list"><li class=meta__item><a class="meta__icon link link--nav" href=/ title=Home rel=nofollow><span class='icon icon--material icon--tiny'><svg viewBox="0 0 20 20"><path d="M3.167 17.667V7.438L10 2.292l6.833 5.146v10.229h-5.75v-5.646H8.896v5.646z"/></svg></span></a></li><li class=meta__item><span class=meta__separator>›</span></li><li class=meta__item><a class="meta__text link link--nav" href=/blog/ rel=nofollow>散文屋
</a><span class=meta__separator>›</span></li><li class=meta__item><a class="meta__text link link--nav" href=/p/73c96d8f7/understand-backquote/ aria-current=page rel=nofollow>关于 backquote 理解的一个汇总与总结</a></li></ul></nav><ul class="meta__list meta__list--date"><li class=meta__item><span class=meta__icon><span class='icon icon--material icon--tiny'><svg viewBox="0 0 20 20"><path d="m16.208 7.604-3.75-3.771 2.271-2.291 3.792 3.75zm-13.75 9.979v-3.75l8.771-8.771 3.75 3.75-8.75 8.771z"/></svg></span>
</span><time class=meta__text datetime=2024-04-21T23:15:00+08:00>Apr 21, 2024</time></li><li class=meta__item><span class=meta__icon><span class='icon icon--material icon--tiny'><svg viewBox="0 0 20 20"><path d="M10 18.5q-1.771.0-3.323-.667-1.552-.666-2.698-1.812t-1.812-2.698Q1.5 11.771 1.5 10t.667-3.323q.666-1.552 1.812-2.698t2.698-1.812Q8.229 1.5 10 1.5t3.323.667q1.552.666 2.698 1.812t1.812 2.698Q18.5 8.229 18.5 10t-.667 3.323q-.666 1.552-1.812 2.698t-2.698 1.812Q11.771 18.5 10 18.5zm2.583-4.562 1.375-1.355-3-2.979V5.896H9.042v4.458z"/></svg></span>
</span><span class=meta__text>11:15 pm</span></li><li class=meta__item><span class=meta__icon><a class="link link--nav" href=/authors/ title="All authors" rel=nofollow><span class='icon icon--material icon--tiny'><svg viewBox="0 0 20 20"><path d="M15.042 11.458V9.042h-2.417V7.208h2.417V4.792h1.833v2.416h2.417v1.834h-2.417v2.416zm-7.48-1.562q-1.479.0-2.489-1.011-1.011-1.01-1.011-2.489.0-1.5 1.011-2.5 1.01-1 2.489-1 1.5.0 2.511 1 1.01 1 1.01 2.5.0 1.479-1.01 2.489-1.011 1.011-2.511 1.011zM.688 16.917v-2.563q0-.792.406-1.406.406-.615 1.052-.948 1.312-.625 2.677-.938 1.365-.312 2.76-.312 1.417.0 2.792.323t2.667.927q.646.312 1.041.938.396.624.396 1.416v2.563z"/></svg></span>
</a></span><a class="meta__text link link--nav" href=/authors/include-yy/ rel=nofollow>Include-yy</a></li></ul></div><hr><nav class=page-nav><ul class=page-nav__list><li class=page-nav__li><a href=/p/42c4ae30a/e-note-text-vs-hand/ class="page-nav__link page-nav__link--prev link link--nav"><span class=page-nav__icon></span><div class=page-nav__title><span class=text>电子笔记方式对比</span></div><span class="page-nav__icon page-nav__icon--arrow"><span class='icon icon--material icon--normal'><svg viewBox="0 0 24 24"><path d="M9.075 18.675 2.4 12l6.675-6.675 1.075 1.05-4.875 4.875h16.15v1.5H5.275l4.85 4.875z"/></svg></span></span></a></li><li class=page-nav__li><a href=/p/de989ed13/messing-with-firefox-appearance/ class="page-nav__link page-nav__link--next link link--nav"><span class=page-nav__icon></span><div class=page-nav__title><span class=text>折腾 Firefox 浏览器（外观篇）</span></div><span class="page-nav__icon page-nav__icon--arrow"><span class='icon icon--material icon--normal'><svg viewBox="0 0 24 24"><path d="m14.725 18.675-1.05-1.05 4.875-4.875H2.4v-1.5h16.15l-4.875-4.875 1.05-1.05 6.7 6.675z"/></svg></span></span></a></li></ul></nav><div class="meta meta--foot"><link href=https://art.celestialy.top/dist/Artalk.css rel=stylesheet><script src=https://art.celestialy.top/dist/Artalk.js></script><div id=Comments></div><script>Artalk.init({el:"#Comments",pageKey:"73c96d8f7",pageTitle:"关于 backquote 理解的一个汇总与总结",server:"https://art.celestialy.top",site:"clsty-css",darkMode:"auto",gravatar:{mirror:"https://cravatar.cn/avatar/",default:"mp"}})</script></div></footer></div><footer id=l-footer class="l-box margin-full-half"><div class=l-footer__columns><div class="md md--footer md--frame footer__col"><h2>clsty 的网络空间站</h2><figure class="fig fig--w-tiny" id=fig-1><a class="img__frame img__frame--box-shadow" href=/about style="display:flex;justify-content:center;align-items:center;background-image:linear-gradient(to right,#333740,#6690dc)"><span class=img__c style=position:relative;width:100%;height:0;padding-bottom:35.7143%><img class="img--ls img--lqip lazyload" data-optimumx=auto data-sizes=auto data-srcset="/site/footer/about._production/avatar-460x164--Center-128x.webp 128w, /site/footer/about._production/avatar-460x164--Center-143x.webp 143w, /site/footer/about._production/avatar-460x164--Center-159x.webp 159w, /site/footer/about._production/avatar-460x164--Center-165x.webp 165w, /site/footer/about._production/avatar-460x164--Center-178x.webp 178w, /site/footer/about._production/avatar-460x164--Center-199x.webp 199w, /site/footer/about._production/avatar-460x164--Center-222x.webp 222w, /site/footer/about._production/avatar-460x164--Center-248x.webp 248w, /site/footer/about._production/avatar-460x164--Center-276x.webp 276w, /site/footer/about._production/avatar-460x164--Center-308x.webp 308w, /site/footer/about._production/avatar-460x164--Center-344x.webp 344w, /site/footer/about._production/avatar-460x164--Center-384x.webp 384w, /site/footer/about._production/avatar-460x164--Center-429x.webp 429w" height=59 src=data:image/webp;base64,UklGRqAAAABXRUJQVlA4IJQAAAAwBgCdASo3ABQAPyV0qEmnI6Ib/VQAcxJE84BgyA3Sir6Y46YmWooQvniL984np5EkEN8Y8dyI/3WAAP654Yuz59xy24p5KprpRxxhEQmsqQZJ0GjaGejMrtSxYmf/vYJBiSU5YrHPhSLv5Oh4zXstEm9DV97WCpt9tTkSKW8AJIdiluzjfGROvoNMeVegTsDuIwAA width=165></span></a></figure><p>2023-2024 © <a class="link link--text" href=/about>clsty</a> 版权所有</p></div><div class="md md--footer md--frame footer__col"><h2>全站内容共享协议</h2><figure class="fig fig--w-tiny" id=cc><a aria-label="Creative Commons 4.0 logo" class="img__frame img__frame--bg-none img__frame--box-shadow" href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans><span class="img__c img__c--t-symbol"><img alt="Creative Commons 4.0 logo" class=img--svg loading=lazy src=/site/footer/cc/by-nc-sa.svg></span></a></figure><p><a class="link link--text" href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans rel=external>CC BY-NC-SA 4.0</a>，除非另作说明</p></div><div class="md md--footer md--frame footer__col"><h2>相关链接</h2><ul><li><a class="link link--text" href=https://css.celestialy.top rel=external>本站（部署于 Cloudflare）</a></li><li><a class="link link--text" href=https://blog.celestialy.top rel=external>本站（部署于 GitHub）</a></li><li><a class="link link--text" href=https://arcn.celestialy.top/ rel=external>arCNiso 文档</a></li><li><a class="link link--text" href=https://alist.celestialy.top rel=external>存储分享（密码 clsty）</a></li></ul></div><div class="md md--footer md--frame footer__col"><h2>站点框架</h2><figure class="fig fig--w-tiny" id=hugo><a aria-label=Hugo class="img__frame img__frame--bg-none img__frame--box-shadow img__frame--pad-half" href=https://gohugo.io><span class="img__c img__c--t-symbol"><img alt=Hugo class=img--svg loading=lazy src=/site/footer/framework/Hugo.2.svg></span></a></figure><figure class="fig fig--w-text" id=perplex><a aria-label=Perplex class="img__frame img__frame--bg-none img__frame--box-shadow img__frame--pad-half" href=https://github.com/bowman2001/perplex><span class="img__c img__c--t-symbol"><svg viewBox="0 0 717 131"><g transform="translate(-13.3,-77.7)" aria-label="PERPLEX"><path d="m13.3 208V78h53.9q17.2.0 25.9 10.6 8.96 10.6 8.96 29.3t-8.96 29.3q-8.77 10.6-25.9 10.6H36.6v50.4zm23.3-70.7h28.2q5.97.0 9.33-3.17 3.55-3.36 3.55-10.6v-11.6q0-7.28-3.55-10.5-3.36-3.36-9.33-3.36H36.6z" fill="#c9177e"/><path d="m123 208V78h78.2v20.3h-54.9v34h48v19.8h-48v35.8h54.9v20.3z" fill="#8b8b8b"/><path d="m247 208h-23.3V78h53.9q17.2.0 25.9 10.5 8.96 10.5 8.96 29.1.0 14.7-5.6 24.5-5.6 9.52-16.4 13.1l23.7 53.2h-25.2l-21.5-51.3h-20.5zm28.2-70.7q5.97.0 9.33-3.17 3.55-3.17 3.55-10.6v-11.6q0-7.47-3.55-10.6-3.36-3.17-9.33-3.17H247v39.2z" fill="#0083c0"/><path d="m333 208V78h53.9q17.2.0 25.9 10.6 8.96 10.6 8.96 29.3t-8.96 29.3q-8.77 10.6-25.9 10.6h-30.6v50.4zm23.3-70.7h28.2q5.97.0 9.33-3.17 3.55-3.36 3.55-10.6v-11.6q0-7.28-3.55-10.5-3.36-3.36-9.33-3.36h-28.2z" fill="#8d8d8d"/><path d="m443 208V78h23.3v110H512v20.3z" fill="#00a88a"/><path d="m533 208V78h78.2v20.3h-54.9v34h48v19.8h-48v35.8h54.9v20.3z" fill="#8b8b8b"/><path d="m730 208h-26.9l-25.4-48.7h-2.43l-25 48.7h-25l37.1-66.6-35.3-63.7h26.7l23.1 45.2h2.61l23.5-45.2h25l-35.8 63.5z" fill="#ebb923"/></g></svg></span></a></figure><p><a class="link link--text" href=https://gohugo.io rel=external>Hugo</a> × <a class="link link--text" href=https://github.com/bowman2001/perplex rel=external>Perplex</a> [Apache 2.0]</p></div></div></footer></main><div id=l-overlay></div></div><script defer src=/js/foot.min.e64a7ab658572cb6d73b058cfbcca1e125e8928a3b71c7b63b88a377133bddbd.js integrity="sha256-5kp6tlhXLLbXOwWM+8yh4SXokoo7cce2O4ijdxM73b0="></script></body></html>